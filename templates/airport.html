<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organisation Task Management</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="position-sticky">
            <div class="sidebar-logo py-3 px-2 mb-2 d-flex justify-content-center align-items-center">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="img-fluid" style="max-height: 40px;">
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="fas fa-users"></i>
                        <span> Patients</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="fas fa-chart-pie"></i>
                        <span> Stats</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="fas fa-chart-bar"></i>
                        <span> Insights</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/airport">
                        <i class="fas fa-tasks"></i>
                        <span> Task Management</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#fhirServerModal">
                        <i class="fas fa-cog me-1"></i><span> Settings</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-primary mb-4"><i class="fas fa-tasks me-2"></i> Organisation Task Management</h2>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <label for="organisationSelect" class="form-label fw-bold">Select Organisation</label>
                    <select id="organisationSelect" class="form-select" required>
                        <option value="">Loading organisations...</option>
                    </select>
                    <div id="orgLoader" class="htmx-indicator mt-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <small class="text-muted ms-2">Loading organisations...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="text-primary mb-0"><i class="fas fa-list me-2"></i>Requested Tasks</h5>
                    <div id="tableLoader" class="htmx-indicator">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="tasksContainer">
                        <div class="alert alert-info m-3">Select an organisation to view tasks</div>
                    </div>
                </div>
                <div id="paginationContainer" class="card-footer d-none">
                    <nav aria-label="Task pagination">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item">
                                <button class="page-link" id="prevBtn" onclick="previousPage()">Previous</button>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link" id="pageInfo">Page 1</span>
                            </li>
                            <li class="page-item">
                                <button class="page-link" id="nextBtn" onclick="nextPage()">Next</button>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div id="detailsPanel" class="card d-none">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="text-primary mb-0"><i class="fas fa-info-circle me-2"></i>Task Details</h5>
                    <button type="button" class="btn-close" aria-label="Close" onclick="closeDetails()"></button>
                </div>
                <div class="card-body">
                    <div id="detailsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
    </div>
</div>

<script>
let currentOrganisation = null;
let currentOffset = 0;
const pageSize = 20;

// Helper function to get FHIR headers from localStorage
function getFhirHeaders() {
    const headers = {
        'Content-Type': 'application/json'
    };
    
    const serverUrl = localStorage.getItem('fhirServerUrl');
    const username = localStorage.getItem('fhirUsername');
    const password = localStorage.getItem('fhirPassword');
    
    if (serverUrl) headers['X-FHIR-Server-URL'] = serverUrl;
    if (username) headers['X-FHIR-Username'] = username;
    if (password) headers['X-FHIR-Password'] = password;
    
    console.log('FHIR Headers being sent:', {
        'X-FHIR-Server-URL': serverUrl ? '***set***' : 'not set',
        'X-FHIR-Username': username ? '***set***' : 'not set',
        'X-FHIR-Password': password ? '***set***' : 'not set'
    });
    
    return headers;
}

// Load organisations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadOrganisations();
    
    // Add change listener to organisation select
    document.getElementById('organisationSelect').addEventListener('change', function() {
        if (this.value) {
            currentOrganisation = JSON.parse(this.value);
            currentOffset = 0;
            loadTasks();
        } else {
            document.getElementById('tasksContainer').innerHTML = '<div class="alert alert-info m-3">Select an organisation to view tasks</div>';
            document.getElementById('paginationContainer').classList.add('d-none');
        }
    });
});

function loadOrganisations() {
    const select = document.getElementById('organisationSelect');
    const loader = document.getElementById('orgLoader');
    
    loader.style.display = 'none'; // Keep hidden - don't show spinner
    
    fetch('/api/organisations/with-tasks', {
        headers: getFhirHeaders()
    })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(organisations => {
            loader.style.display = 'none';
            
            if (!Array.isArray(organisations)) {
                throw new Error('Invalid response format');
            }
            
            if (organisations.length === 0) {
                select.innerHTML = '<option value="">No organisations found</option>';
                showToast('warning', 'No Organisations', 'No organisations with group tasks were found.');
                return;
            }
            
            select.innerHTML = '<option value="">Select an organisation...</option>';
            organisations.forEach(org => {
                const option = document.createElement('option');
                option.value = JSON.stringify(org);
                option.textContent = `${org.name} (${org.identifier})`;
                select.appendChild(option);
            });
        })
        .catch(error => {
            loader.style.display = 'none';
            console.error('Error loading organisations:', error);
            select.innerHTML = '<option value="">Error loading organisations</option>';
            if (typeof showToast === 'function') {
                showToast('danger', 'Error', 'Failed to load organisations.');
            }
        });
}

function loadTasks() {
    if (!currentOrganisation) {
        console.warn('No organisation selected');
        return;
    }
    
    if (!currentOrganisation.identifier) {
        console.error('Organisation has no identifier:', currentOrganisation);
        showToast('danger', 'Error', 'Organisation identifier not found');
        return;
    }
    
    const loader = document.getElementById('tableLoader');
    const container = document.getElementById('tasksContainer');
    
    loader.style.display = 'inline-block';
    
    const url = `/api/tasks/by-org?org_identifier=${encodeURIComponent(currentOrganisation.identifier)}&offset=${currentOffset}&limit=${pageSize}`;
    
    console.log('Loading tasks from:', url);
    console.log('Current organisation:', currentOrganisation);
    
    fetch(url, {
        headers: getFhirHeaders()
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || `HTTP ${response.status}`);
                }).catch(() => {
                    throw new Error(`HTTP ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            loader.style.display = 'none';
            console.log('Tasks response:', data);
            
            if (data.error) {
                const errorMsg = data.details ? `${data.error}: ${data.details}` : data.error;
                console.error('Task fetch error:', errorMsg);
                showToast('danger', 'Error', errorMsg);
                container.innerHTML = `<div class="alert alert-danger m-3">${escapeHtml(errorMsg)}</div>`;
                return;
            }
            
            const tasks = data.tasks || [];
            const groupTasks = data.groupTasks || [];
            const totalCount = data.totalCount || 0;
            
            if (tasks.length === 0 && groupTasks.length === 0) {
                container.innerHTML = '<div class="alert alert-info m-3">No requested tasks found for this organisation.</div>';
                document.getElementById('paginationContainer').classList.add('d-none');
                return;
            }
            
            // Build table HTML
            let html = `
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Patient Name / DOB</th>
                            <th>Identifier</th>
                            <th>Service Request</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th width="200">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Helper function to get first available identifier
            function getFirstIdentifier(identifiers) {
                if (!identifiers) return '-';
                if (identifiers.ihi) return `IHI: ${identifiers.ihi}`;
                if (identifiers.medicare) return `Medicare: ${identifiers.medicare}`;
                if (identifiers.dva) return `DVA: ${identifiers.dva}`;
                return '-';
            }
            
            // Add group tasks
            groupTasks.forEach(task => {
                const dob = task.patient_dob ? ` (DOB: ${task.patient_dob})` : '';
                const serviceRequestDisplay = task.serviceRequest?.placer_group_number ? escapeHtml(task.serviceRequest.placer_group_number) : escapeHtml(task.description);
                html += `
                    <tr class="table-primary">
                        <td><strong>${escapeHtml(task.patient_name)}${dob}</strong></td>
                        <td>${getFirstIdentifier(task.patient_identifiers)}</td>
                        <td><strong>${serviceRequestDisplay}</strong></td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateTaskStatus('${task.id}', this.value)">
                                <option value="">Select status...</option>
                                <option value="accepted" ${task.status === 'accepted' ? 'selected' : ''}>Accept</option>
                                <option value="cancelled" ${task.status === 'cancelled' ? 'selected' : ''}>Cancel</option>
                            </select>
                        </td>
                        <td><span class="badge bg-secondary">${escapeHtml(task.priority)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showDetails('${task.id}')">
                                <i class="fas fa-info-circle me-1"></i>
                                Details
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            // Add child tasks
            tasks.forEach(task => {
                const dob = task.patient_dob ? ` (DOB: ${task.patient_dob})` : '';
                const serviceRequestDisplay = task.serviceRequest?.placer_group_number ? escapeHtml(task.serviceRequest.placer_group_number) : escapeHtml(task.description);
                html += `
                    <tr>
                        <td>${escapeHtml(task.patient_name)}${dob}</td>
                        <td>${getFirstIdentifier(task.patient_identifiers)}</td>
                        <td>${serviceRequestDisplay}</td>
                        <td><span class="badge bg-warning">${escapeHtml(task.status)}</span></td>
                        <td><span class="badge bg-secondary">${escapeHtml(task.priority)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showDetails('${task.id}')">
                                <i class="fas fa-info-circle me-1"></i>
                                Details
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            
            // Update pagination
            updatePagination(totalCount);
        })
        .catch(error => {
            loader.style.display = 'none';
            console.error('Error loading tasks:', error);
            container.innerHTML = `<div class="alert alert-danger m-3">Error loading tasks: ${escapeHtml(error.message)}</div>`;
            showToast('danger', 'Error', error.message || 'Failed to load tasks.');
        });
}

function updatePagination(totalCount) {
    const paginationContainer = document.getElementById('paginationContainer');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    
    const currentPage = Math.floor(currentOffset / pageSize) + 1;
    const totalPages = Math.ceil(totalCount / pageSize);
    
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    
    prevBtn.disabled = currentOffset === 0;
    nextBtn.disabled = currentOffset + pageSize >= totalCount;
    
    paginationContainer.classList.remove('d-none');
}

function nextPage() {
    currentOffset += pageSize;
    loadTasks();
    document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

function previousPage() {
    currentOffset = Math.max(0, currentOffset - pageSize);
    loadTasks();
    document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

function updateTaskStatus(taskId, newStatus) {
    if (!newStatus) {
        return;
    }
    
    const button = event.target;
    button.disabled = true;
    
    const formData = new FormData();
    formData.append('newStatus', newStatus);
    
    fetch(`/api/task-groups/${taskId}/status`, {
        method: 'POST',
        headers: getFhirHeaders(),
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        button.disabled = false;
        
        if (data.error) {
            showToast('danger', 'Invalid Transition', data.message || data.error);
            loadTasks(); // Reload to reset the dropdown
        } else {
            showToast('success', 'Status Updated', `Task status updated to ${newStatus}`);
            loadTasks(); // Reload tasks to reflect changes
        }
    })
    .catch(error => {
        button.disabled = false;
        console.error('Error updating status:', error);
        showToast('danger', 'Error', 'Failed to update task status.');
    });
}

function showDetails(taskId) {
    const detailsPanel = document.getElementById('detailsPanel');
    const detailsContent = document.getElementById('detailsContent');
    
    // For now, show basic details from the task data
    // In a full implementation, you'd fetch detailed ServiceRequest info
    detailsContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Task ID:</strong> ${escapeHtml(taskId)}</p>
                <p><strong>Service Request:</strong> Detailed view coming soon</p>
            </div>
            <div class="col-md-6">
                <p><strong>Status:</strong> Check the table above</p>
                <p><strong>Priority:</strong> Check the table above</p>
            </div>
        </div>
    `;
    
    detailsPanel.classList.remove('d-none');
    detailsPanel.scrollIntoView({ behavior: 'smooth' });
}

function closeDetails() {
    document.getElementById('detailsPanel').classList.add('d-none');
}

function showToast(type, title, message) {
    const toast = document.getElementById('statusToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastBody = document.getElementById('toastBody');
    
    toastTitle.textContent = title;
    toastBody.textContent = message;
    
    // Update toast styling based on type
    toast.className = 'toast';
    if (type === 'danger') {
        toast.classList.add('border-danger');
        toastTitle.style.color = '#dc3545';
    } else if (type === 'success') {
        toast.classList.add('border-success');
        toastTitle.style.color = '#198754';
    } else if (type === 'warning') {
        toast.classList.add('border-warning');
        toastTitle.style.color = '#ffc107';
    } else {
        toast.classList.add('border-info');
        toastTitle.style.color = '#0dcaf0';
    }
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Ensure showToast doesn't fail if Bootstrap is not available
if (typeof window.bootstrap === 'undefined') {
    const originalShowToast = showToast;
    showToast = function(type, title, message) {
        console.warn(`Toast (${type}): ${title} - ${message}`);
        // Fallback: just log to console
    };
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function saveFhirSettings() {
    const serverUrl = document.getElementById('fhirServerUrl').value;
    const username = document.getElementById('fhirUsername').value;
    const password = document.getElementById('fhirPassword').value;
    
    if (!serverUrl || !username || !password) {
        showToast('danger', 'Error', 'Please fill in all fields');
        return;
    }
    
    localStorage.setItem('fhirServerUrl', serverUrl);
    localStorage.setItem('fhirUsername', username);
    localStorage.setItem('fhirPassword', password);
    
    showToast('success', 'Settings Saved', 'FHIR server settings have been saved');
    bootstrap.Modal.getInstance(document.getElementById('fhirServerModal')).hide();
}

// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    const serverUrl = localStorage.getItem('fhirServerUrl');
    const username = localStorage.getItem('fhirUsername');
    const password = localStorage.getItem('fhirPassword');
    
    if (serverUrl) document.getElementById('fhirServerUrl').value = serverUrl;
    if (username) document.getElementById('fhirUsername').value = username;
    if (password) document.getElementById('fhirPassword').value = password;
});
</script>

<style>
    :root {
        --tropical-primary: #2E86AB;
        --tropical-secondary: #F18F01;
        --tropical-success: #5AAA95;
        --tropical-danger: #E63946;
        --tropical-info: #5BC0BE;
        --tropical-light: #FEF9EF;
        --tropical-dark: #293241;
    }
    
    /* Match dashboard card styling */
    .card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: none;
        margin-bottom: 1.5rem;
    }
    
    .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
        padding: 1rem 1.25rem;
        border-bottom: none;
    }
    
    .card-header.bg-primary {
        background-color: var(--tropical-primary) !important;
    }
    
    .card-header.bg-info {
        background-color: var(--tropical-info) !important;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .card-footer {
        background-color: rgba(0, 0, 0, 0.02);
        padding: 1rem 1.25rem;
    }
    
    /* Form styling */
    .form-select, .form-control {
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }
    
    .form-select:focus, .form-control:focus {
        border-color: var(--tropical-primary);
        box-shadow: 0 0 0 0.2rem rgba(46, 134, 171, 0.25);
    }
    
    /* Table styling */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .table-primary {
        background-color: #e7f1f8 !important;
        font-weight: 500;
    }
    
    /* Pagination styling */
    .pagination .page-link {
        border-radius: 6px;
        margin: 0 2px;
        color: var(--tropical-primary);
    }
    
    .pagination .page-link:hover {
        background-color: #e7f1f8;
        color: var(--tropical-primary);
    }
    
    .pagination .page-link:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    /* Toast styling */
    .toast {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    #statusToast {
        min-width: 350px;
    }
    
    /* Loader visibility - hide by default */
    #orgLoader, #tableLoader {
        display: none !important;
    }
    
    /* Page heading */
    h1 {
        color: var(--tropical-dark);
        font-weight: 700;
        margin-bottom: 1.5rem;
    }
</style>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FHIR Settings Modal -->
    <div class="modal fade" id="fhirServerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">FHIR Server Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fhirServerUrl" class="form-label">FHIR Server URL</label>
                        <input type="url" class="form-control" id="fhirServerUrl" placeholder="https://example.com/fhir">
                    </div>
                    <div class="mb-3">
                        <label for="fhirUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="fhirUsername">
                    </div>
                    <div class="mb-3">
                        <label for="fhirPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="fhirPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveFhirSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
</main>
</body>
</html>
