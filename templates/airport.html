<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organisation Task Management</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    {% set active_page = 'airport' %}
    {% include 'partials/sidebar.html' %}

    <!-- Main Content -->
    <main class="main-content">
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="text-primary mb-4"><i class="fas fa-tasks me-2"></i> Organisation Task Management</h2>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <label class="form-label fw-bold">Request Context <small class="fw-normal text-muted">(filters organisations)</small></label>
                    <div class="btn-group w-100" role="group" aria-label="Request context">
                        <input type="radio" class="btn-check" name="requestContext" id="contextPathology" value="pathology" autocomplete="off">
                        <label class="btn btn-outline-primary" for="contextPathology">
                            <i class="fas fa-flask me-1"></i>Pathology
                        </label>
                        <input type="radio" class="btn-check" name="requestContext" id="contextRadiology" value="radiology" autocomplete="off">
                        <label class="btn btn-outline-primary" for="contextRadiology">
                            <i class="fas fa-x-ray me-1"></i>Radiology
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <label for="organisationSelect" class="form-label fw-bold">Select Organisation</label>
                    <select id="organisationSelect" class="form-select" required>
                        <option value="">Select a request context first...</option>
                    </select>
                    <div id="orgLoader" class="htmx-indicator mt-2">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <small class="text-muted ms-2">Loading organisations...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="text-primary mb-0"><i class="fas fa-list me-2"></i>Requested Tasks</h5>
                    <div id="tableLoader" class="htmx-indicator">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="tasksContainer">
                        <div class="alert alert-info m-3">Select an organisation to view tasks</div>
                    </div>
                </div>
                <div id="paginationContainer" class="card-footer d-none">
                    <nav aria-label="Task pagination">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item">
                                <button class="page-link" id="prevBtn" onclick="previousPage()">Previous</button>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link" id="pageInfo">Page 1</span>
                            </li>
                            <li class="page-item">
                                <button class="page-link" id="nextBtn" onclick="nextPage()">Next</button>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div id="detailsPanel" class="card d-none">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="text-primary mb-0"><i class="fas fa-info-circle me-2"></i>Task Details</h5>
                    <button type="button" class="btn-close" aria-label="Close" onclick="closeDetails()"></button>
                </div>
                <div class="card-body">
                    <div id="detailsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
    </div>
</div>

<script>
let currentOrganisation = null;
let currentOffset = 0;
let currentTasks = {};
let currentDetailTaskId = null;
let allOrganisations = []; // Store all organisations for filtering
const pageSize = 20;

// Helper function to get FHIR headers from localStorage
function getFhirHeaders() {
    const headers = {
        'Content-Type': 'application/json'
    };
    
    const serverUrl = localStorage.getItem('fhirServerUrl');
    const username = localStorage.getItem('fhirUsername');
    const password = localStorage.getItem('fhirPassword');
    
    if (serverUrl) headers['X-FHIR-Server-URL'] = serverUrl;
    if (username) headers['X-FHIR-Username'] = username;
    if (password) headers['X-FHIR-Password'] = password;
    
    console.log('FHIR Headers being sent:', {
        'X-FHIR-Server-URL': serverUrl ? '***set***' : 'not set',
        'X-FHIR-Username': username ? '***set***' : 'not set',
        'X-FHIR-Password': password ? '***set***' : 'not set'
    });
    
    return headers;
}

// Task status transitions - matches backend TASK_STATUS_TRANSITIONS
const TASK_STATUS_TRANSITIONS = {
    'draft': ['requested', 'cancelled'],
    'requested': ['accepted', 'cancelled'],
    'accepted': ['in-progress', 'completed', 'failed', 'cancelled'],
    'in-progress': ['completed', 'failed', 'cancelled'],
    'completed': [],
    'failed': [],
    'cancelled': []
};

// Status display labels
const STATUS_LABELS = {
    'draft': 'Draft',
    'requested': 'Requested',
    'accepted': 'Accept',
    'in-progress': 'In Progress',
    'completed': 'Complete',
    'failed': 'Failed',
    'cancelled': 'Cancel'
};

// Business status codes valid for each Task status - matches backend BUSINESS_STATUS_BY_TASK_STATUS
const BUSINESS_STATUS_BY_TASK_STATUS = {
    'accepted': [
        {code: 'booked', display: 'Booked', context: 'shared'}
    ],
    'in-progress': [
        {code: 'preliminary', display: 'Preliminary Result', context: 'shared'},
        {code: 'collected', display: 'Specimen Collected', context: 'pathology'},
        {code: 'in-lab', display: 'In Lab', context: 'pathology'},
        {code: 'acquired', display: 'Image Acquired', context: 'radiology'}
    ],
    'completed': [
        {code: 'addendum', display: 'Addendum', context: 'shared'}
    ],
    'cancelled': [
        {code: 'claimed', display: 'Claimed by Alt. Filler', context: 'shared'},
        {code: 'user-cancelled', display: 'User Cancelled', context: 'shared'},
        {code: 'cancel-handled', display: 'Cancellation Handled', context: 'shared'}
    ],
    'rejected': [
        {code: 'data-issue', display: 'Data Issue', context: 'shared'}
    ]
};

// Get current request context (pathology or radiology) - default to shared
let currentRequestContext = 'shared';

// Generate status transition dropdown options based on current status
function getStatusTransitionOptions(currentStatus) {
    const transitions = TASK_STATUS_TRANSITIONS[currentStatus?.toLowerCase()] || [];
    if (transitions.length === 0) return '';
    
    return transitions.map(status => 
        `<option value="${status}">${STATUS_LABELS[status] || status.charAt(0).toUpperCase() + status.slice(1)}</option>`
    ).join('');
}

// Generate business status dropdown options based on current task status and context
function getBusinessStatusOptions(taskStatus, context = 'shared') {
    const statuses = BUSINESS_STATUS_BY_TASK_STATUS[taskStatus?.toLowerCase()] || [];
    if (statuses.length === 0) return '';
    
    // Filter by context - include 'shared' and context-specific
    const filteredStatuses = statuses.filter(s => s.context === 'shared' || s.context === context);
    if (filteredStatuses.length === 0) return '';
    
    return filteredStatuses.map(s => 
        `<option value="${s.code}">${s.display}</option>`
    ).join('');
}

// Load organisations on page load
document.addEventListener('DOMContentLoaded', function() {
    loadOrganisations();
    
    // Add change listener to organisation select
    document.getElementById('organisationSelect').addEventListener('change', function() {
        if (this.value) {
            currentOrganisation = JSON.parse(this.value);
            currentOffset = 0;
            loadTasks();
        } else {
            document.getElementById('tasksContainer').innerHTML = '<div class="alert alert-info m-3">Select an organisation to view tasks</div>';
            document.getElementById('paginationContainer').classList.add('d-none');
        }
    });
    
    // Add change listeners for request context radio buttons
    document.querySelectorAll('input[name="requestContext"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentRequestContext = this.value;
            console.log('Request context changed to:', currentRequestContext);
            // Filter organisations based on new context
            filterOrganisations();
            // Reload tasks to update business status dropdowns (if org still selected)
            if (currentOrganisation) {
                loadTasks();
            }
        });
    });
});

function loadOrganisations() {
    const select = document.getElementById('organisationSelect');
    const loader = document.getElementById('orgLoader');
    
    loader.style.display = 'none'; // Keep hidden - don't show spinner
    
    fetch('/api/organisations/with-tasks', {
        headers: getFhirHeaders()
    })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(organisations => {
            loader.style.display = 'none';
            
            if (!Array.isArray(organisations)) {
                throw new Error('Invalid response format');
            }
            
            if (organisations.length === 0) {
                select.innerHTML = '<option value="">No organisations found</option>';
                showToast('warning', 'No Organisations', 'No organisations with group tasks were found.');
                return;
            }
            
            // Store all organisations for filtering
            allOrganisations = organisations;
            
            // Apply initial filter based on current context
            filterOrganisations();
        })
        .catch(error => {
            loader.style.display = 'none';
            console.error('Error loading organisations:', error);
            select.innerHTML = '<option value="">Error loading organisations</option>';
            if (typeof showToast === 'function') {
                showToast('danger', 'Error', 'Failed to load organisations.');
            }
        });
}

function filterOrganisations() {
    const select = document.getElementById('organisationSelect');
    
    // Filter organisations based on current request context
    // Match org.type to currentRequestContext (pathology, radiology, other)
    const filteredOrgs = allOrganisations.filter(org => {
        // If no type specified, show in all contexts
        if (!org.type) return true;
        
        const orgType = org.type.toLowerCase();
        
        // Match pathology context to pathology orgs
        if (currentRequestContext === 'pathology') {
            return orgType.includes('pathology') || orgType.includes('laboratory') || orgType.includes('path');
        }
        // Match radiology context to radiology orgs
        if (currentRequestContext === 'radiology') {
            return orgType.includes('radiology') || orgType.includes('imaging') || orgType.includes('rad');
        }
        // For 'other', show orgs that don't match pathology or radiology
        if (currentRequestContext === 'other') {
            return !orgType.includes('pathology') && !orgType.includes('laboratory') && !orgType.includes('path') &&
                   !orgType.includes('radiology') && !orgType.includes('imaging') && !orgType.includes('rad');
        }
        
        return true;
    });
    
    // Clear current selection if selected org doesn't match new filter
    const currentValue = select.value;
    let currentOrgStillValid = false;
    
    if (filteredOrgs.length === 0) {
        select.innerHTML = '<option value="">No organisations match this context</option>';
        // Reset current organisation if none match
        currentOrganisation = null;
        clearTasksDisplay();
        return;
    }
    
    select.innerHTML = '<option value="">Select an organisation...</option>';
    filteredOrgs.forEach(org => {
        const option = document.createElement('option');
        const orgJson = JSON.stringify(org);
        option.value = orgJson;
        option.textContent = `${org.name} (${org.identifier})`;
        select.appendChild(option);
        
        // Check if previously selected org is still in filtered list
        if (currentValue && currentValue === orgJson) {
            currentOrgStillValid = true;
        }
    });
    
    // Restore selection if still valid, otherwise reset
    if (currentOrgStillValid) {
        select.value = currentValue;
    } else if (currentOrganisation) {
        // Previously selected org no longer matches filter
        currentOrganisation = null;
        clearTasksDisplay();
        showToast('info', 'Selection Cleared', 'Previously selected organisation does not match the new context.');
    }
}

function clearTasksDisplay() {
    const tableBody = document.getElementById('taskTableBody');
    if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Select an organisation to view tasks</td></tr>';
    }
    // Hide details panel if open
    const detailsPanel = document.getElementById('taskDetailsPanel');
    if (detailsPanel) {
        detailsPanel.style.display = 'none';
    }
}

function loadTasks() {
        const callTimestamp = Date.now();
        console.log(`[DEBUG ${callTimestamp}] loadTasks() called`);
    
    if (!currentOrganisation) {
        console.warn(`[DEBUG ${callTimestamp}] No organisation selected`);
        return;
    }
    
    if (!currentOrganisation.identifier) {
        console.error('Organisation has no identifier:', currentOrganisation);
        showToast('danger', 'Error', 'Organisation identifier not found');
        return;
    }
    
    const loader = document.getElementById('tableLoader');
    const container = document.getElementById('tasksContainer');
    
    loader.style.display = 'inline-block';
    
    const url = `/api/tasks/by-org?org_identifier=${encodeURIComponent(currentOrganisation.identifier)}&offset=${currentOffset}&limit=${pageSize}`;
    
    console.log(`[DEBUG ${callTimestamp}] Loading tasks from:`, url);
    console.log(`[DEBUG ${callTimestamp}] Current organisation:`, currentOrganisation);
    
    fetch(url, {
        headers: getFhirHeaders()
    })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || `HTTP ${response.status}`);
                }).catch(() => {
                    throw new Error(`HTTP ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            loader.style.display = 'none';
            console.log(`[DEBUG ${callTimestamp}] Tasks response:`, data);
            console.log(`[DEBUG ${callTimestamp}] Request context:`, currentRequestContext);
            console.log(`[DEBUG ${callTimestamp}] Selected organisation:`, currentOrganisation);
            
            if (data.error) {
                const errorMsg = data.details ? `${data.error}: ${data.details}` : data.error;
                console.error('Task fetch error:', errorMsg);
                showToast('danger', 'Error', errorMsg);
                container.innerHTML = `<div class="alert alert-danger m-3">${escapeHtml(errorMsg)}</div>`;
                return;
            }
            
            const tasks = data.tasks || [];
            const groupTasks = data.groupTasks || [];
            currentTasks = {};
            const totalCount = data.totalCount || 0;
            
            console.log(`[DEBUG ${callTimestamp}] Processing groupTasks count:`, groupTasks.length);
            if (groupTasks.length > 0) {
                console.log(`[DEBUG ${callTimestamp}] Sample groupTask:`, groupTasks[0]);
            }
            
            if (tasks.length === 0 && groupTasks.length === 0) {
                container.innerHTML = '<div class="alert alert-info m-3">No requested tasks found for this organisation.</div>';
                document.getElementById('paginationContainer').classList.add('d-none');
                return;
            }
            
            // Helper function to get status badge color
            function getStatusBadgeClass(status) {
                const statusMap = {
                    'requested': 'bg-info',
                    'accepted': 'bg-success',
                    'in-progress': 'bg-primary',
                    'completed': 'bg-secondary',
                    'cancelled': 'bg-danger',
                    'on-hold': 'bg-warning text-dark',
                    'failed': 'bg-danger',
                    'rejected': 'bg-danger',
                    'ready': 'bg-info',
                    'received': 'bg-info',
                    'draft': 'bg-light text-dark'
                };
                return statusMap[status?.toLowerCase()] || 'bg-secondary';
            }
            
            // Build table HTML
            let html = `
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Patient Name / DOB</th>
                            <th>Identifier</th>
                            <th>Service Request</th>
                            <th>Current Status</th>
                            <th>Update Status</th>
                            <th>Business Status</th>
                            <th>Priority</th>
                            <th width="100">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Helper function to get first available identifier
            function getFirstIdentifier(identifiers) {
                if (!identifiers) return '-';
                if (identifiers.ihi) return `IHI: ${identifiers.ihi}`;
                if (identifiers.medicare) return `Medicare: ${identifiers.medicare}`;
                if (identifiers.dva) return `DVA: ${identifiers.dva}`;
                return '-';
            }
            
            // Sort group tasks: requested at top, then other statuses alphabetically
            function getStatusSortOrder(status) {
                const orderMap = {
                    'requested': 0,
                    'received': 1,
                    'ready': 2,
                    'in-progress': 3,
                    'on-hold': 4,
                    'accepted': 5,
                    'completed': 6,
                    'cancelled': 7,
                    'rejected': 8,
                    'failed': 9
                };
                return orderMap[status?.toLowerCase()] ?? 5;
            }
            
            groupTasks.sort((a, b) => {
                return getStatusSortOrder(a.status) - getStatusSortOrder(b.status);
            });
            
            // Add group tasks
            console.log(`[DEBUG ${callTimestamp}] Building HTML for`, groupTasks.length, 'group tasks');
            try {
                groupTasks.forEach((task, index) => {
                    console.log(`[DEBUG ${callTimestamp}] Processing group task ${index + 1}/${groupTasks.length}:`, task.id);
                    currentTasks[task.id] = task;
                    const dob = task.patient_dob ? ` (DOB: ${task.patient_dob})` : '';
                    const serviceRequestDisplay = task.serviceRequest?.placer_group_number ? escapeHtml(task.serviceRequest.placer_group_number) : escapeHtml(task.description);
                    const statusBadgeClass = getStatusBadgeClass(task.status);
                    const statusDisplay = task.status ? task.status.charAt(0).toUpperCase() + task.status.slice(1) : 'Unknown';
                    const statusOptions = getStatusTransitionOptions(task.status);
                    const businessStatusOptions = getBusinessStatusOptions(task.status, currentRequestContext);
                    const currentBusinessStatus = task.businessStatus || '';
                    const businessStatusDisplay = currentBusinessStatus ? currentBusinessStatus.charAt(0).toUpperCase() + currentBusinessStatus.slice(1).replace('-', ' ') : '';
                    html += `
                    <tr class="table-primary">
                        <td><strong>${escapeHtml(task.patient_name)}${dob}</strong></td>
                        <td>${getFirstIdentifier(task.patient_identifiers)}</td>
                        <td><strong>${serviceRequestDisplay}</strong></td>
                        <td><span class="badge ${statusBadgeClass}">${escapeHtml(statusDisplay)}</span></td>
                        <td>
                            ${statusOptions.length > 0 ? `
                            <select class="form-select form-select-sm" onchange="updateTaskStatus('${task.id}', this.value)">
                                <option value="">Update status...</option>
                                ${statusOptions}
                            </select>
                            ` : '<span class="text-muted small">No transitions</span>'}
                        </td>
                        <td>
                            ${businessStatusOptions.length > 0 ? `
                            <select class="form-select form-select-sm" onchange="updateBusinessStatus('${task.id}', this.value)">
                                <option value="">${currentBusinessStatus ? escapeHtml(businessStatusDisplay) : 'Set business status...'}</option>
                                ${businessStatusOptions}
                            </select>
                            ` : '<span class="text-muted small">-</span>'}
                        </td>
                        <td><span class="badge bg-secondary">${escapeHtml(task.priority)}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showDetails('${task.id}')" title="View Details">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </td>
                    </tr>
                    `;
                });
                console.log(`[DEBUG ${callTimestamp}] Finished building HTML for group tasks`);
            } catch (error) {
                console.error(`[DEBUG ${callTimestamp}] Error building group tasks HTML:`, error);
                showToast('danger', 'Error', 'Failed to render tasks: ' + error.message);
                return;
            }
            
            // Child tasks are not displayed in table - only used for SR code extraction in backend
            // Store them in currentTasks for details panel access if needed
            tasks.forEach(task => {
                currentTasks[task.id] = task;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            console.log(`[DEBUG ${callTimestamp}] About to update table. GroupTasks count:`, groupTasks.length);
            console.log(`[DEBUG ${callTimestamp}] Container element exists:`, !!container);
            console.log(`[DEBUG ${callTimestamp}] Generated HTML length:`, html.length);
            console.log(`[DEBUG ${callTimestamp}] First 200 chars of HTML:`, html.substring(0, 200));
            
            // Update the container
            container.innerHTML = html;
            console.log(`[DEBUG ${callTimestamp}] Table HTML updated. New innerHTML length:`, container.innerHTML.length);
            
            // Update pagination
            updatePagination(totalCount);

            // Refresh details panel if it is visible
            const detailsPanel = document.getElementById('detailsPanel');
            if (detailsPanel && !detailsPanel.classList.contains('d-none')) {
                if (currentDetailTaskId && currentTasks[currentDetailTaskId]) {
                    showDetails(currentDetailTaskId);
                } else {
                    detailsPanel.classList.add('d-none');
                    currentDetailTaskId = null;
                }
            }
        })
        .catch(error => {
            loader.style.display = 'none';
            console.error('Error loading tasks:', error);
            container.innerHTML = `<div class="alert alert-danger m-3">Error loading tasks: ${escapeHtml(error.message)}</div>`;
            showToast('danger', 'Error', error.message || 'Failed to load tasks.');
        });
}

function updatePagination(totalCount) {
    const paginationContainer = document.getElementById('paginationContainer');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    
    const currentPage = Math.floor(currentOffset / pageSize) + 1;
    const totalPages = Math.ceil(totalCount / pageSize);
    
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    
    prevBtn.disabled = currentOffset === 0;
    nextBtn.disabled = currentOffset + pageSize >= totalCount;
    
    paginationContainer.classList.remove('d-none');
}

function nextPage() {
    currentOffset += pageSize;
    loadTasks();
    document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

function previousPage() {
    currentOffset = Math.max(0, currentOffset - pageSize);
    loadTasks();
    document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

function updateTaskStatus(taskId, newStatus) {
    if (!newStatus) {
        return;
    }
    
    const button = event.target;
    button.disabled = true;
    
    const formData = new FormData();
    formData.append('newStatus', newStatus);
    
    // Get FHIR headers but don't set Content-Type (browser will set it for FormData)
    const headers = getFhirHeaders();
    delete headers['Content-Type']; // Remove Content-Type so browser sets it with boundary for multipart/form-data
    
    fetch(`/api/task-groups/${taskId}/status`, {
        method: 'POST',
        headers: headers,
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || err.error || `HTTP ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        button.disabled = false;
        
        if (data.error) {
            showToast('danger', 'Invalid Transition', data.message || data.error);
            loadTasks(); // Reload to reset the dropdown
        } else {
            const statusText = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
            showToast('success', 'Status Updated', `Task group and ${data.updatedCount} child task(s) updated to ${statusText}. Refreshing list...`);
            
            // Close the details panel since the task status has changed
            const detailsPanel = document.getElementById('detailsPanel');
            if (detailsPanel) {
                detailsPanel.classList.add('d-none');
            }
            
            // Show loading indicator immediately
            const loader = document.getElementById('tableLoader');
            if (loader) {
                loader.style.display = 'inline-block';
            }
            
            // Reload tasks after a brief delay to ensure FHIR server has processed the update
            setTimeout(() => {
                loadTasks();
            }, 300);
        }
    })
    .catch(error => {
        button.disabled = false;
        console.error('Error updating status:', error);
        showToast('danger', 'Error', error.message || 'Failed to update task status.');
        loadTasks(); // Reload to reset the dropdown
    });
}

function updateBusinessStatus(taskId, newBusinessStatus) {
    if (!newBusinessStatus) {
        return;
    }
    
    const button = event.target;
    button.disabled = true;
    
    const formData = new FormData();
    formData.append('newBusinessStatus', newBusinessStatus);
    formData.append('context', currentRequestContext);
    
    // Get FHIR headers but don't set Content-Type (browser will set it for FormData)
    const headers = getFhirHeaders();
    delete headers['Content-Type'];
    
    fetch(`/api/task-groups/${taskId}/business-status`, {
        method: 'POST',
        headers: headers,
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || err.error || `HTTP ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        button.disabled = false;
        
        if (data.error) {
            showToast('danger', 'Invalid Business Status', data.message || data.error);
            loadTasks(); // Reload to reset the dropdown
        } else {
            const statusDisplay = newBusinessStatus.charAt(0).toUpperCase() + newBusinessStatus.slice(1).replace('-', ' ');
            showToast('success', 'Business Status Updated', `Task group and ${data.updatedCount} child task(s) updated to "${statusDisplay}". Refreshing list...`);
            
            // Show loading indicator immediately
            const loader = document.getElementById('tableLoader');
            if (loader) {
                loader.style.display = 'inline-block';
            }
            
            // Reload tasks after a brief delay
            setTimeout(() => {
                loadTasks();
            }, 300);
        }
    })
    .catch(error => {
        button.disabled = false;
        console.error('Error updating business status:', error);
        showToast('danger', 'Error', error.message || 'Failed to update business status.');
        loadTasks(); // Reload to reset the dropdown
    });
}

function showDetails(taskId) {
    const detailsPanel = document.getElementById('detailsPanel');
    const detailsContent = document.getElementById('detailsContent');
    const task = currentTasks[taskId];

    currentDetailTaskId = taskId;

    console.log('showDetails called for taskId:', taskId);
    console.log('Task data:', task);

    if (!task) {
        detailsContent.innerHTML = `<p class="text-danger">Task details not found.</p>`;
        detailsPanel.classList.remove('d-none');
        return;
    }

    // Helper function to get status badge color (consistent with table badges)
    function getStatusBadgeColor(status) {
        const statusMap = {
            'requested': 'info',
            'accepted': 'success',
            'in-progress': 'primary',
            'completed': 'secondary',
            'failed': 'danger',
            'cancelled': 'danger',
            'on-hold': 'warning',
            'rejected': 'danger',
            'ready': 'info',
            'received': 'info',
            'draft': 'secondary',
            'unknown': 'secondary'
        };
        return statusMap[status?.toLowerCase()] || 'secondary';
    }

    // Helper function to get priority badge color (urgent/asap/stat = red, routine = grey)
    function getPriorityBadgeColor(priority) {
        const p = (priority || 'routine').toLowerCase();
        // Red for high priority items
        if (p === 'urgent' || p === 'asap' || p === 'stat' || p === 'emergency') {
            return 'danger';
        }
        // Grey for routine
        if (p === 'routine') {
            return 'secondary';
        }
        // Yellow for any other priority level
        return 'warning';
    }

    const sr = task.serviceRequest || {};
    console.log('ServiceRequest:', sr);
    console.log('SR codes array:', sr.codes);
    console.log('Child tasks:', task.childTasks);
    
    // Build individual tasks display
    let testsHtml = '';
    if (task.childTasks && task.childTasks.length > 0) {
        // Sort by displaySequence if available
        const sortedChildren = [...task.childTasks].sort((a, b) => {
            const seqA = a.displaySequence ?? 999;
            const seqB = b.displaySequence ?? 999;
            return seqA - seqB;
        });
        
        // Display individual child tasks with their code displays
        testsHtml = '<table class="table table-sm table-bordered mt-2"><thead><tr><th>Seq#</th><th>PON</th><th>Test</th><th>Priority</th><th>Authored</th><th>Status</th></tr></thead><tbody>';
        sortedChildren.forEach(child => {
            const childStatus = child.status || 'unknown';
            const statusBadge = `<span class="badge bg-${getStatusBadgeColor(childStatus)}">${escapeHtml(childStatus)}</span>`;
            const seqDisplay = child.displaySequence != null ? child.displaySequence : '-';
            const ponDisplay = child.placerOrderNumber ? escapeHtml(child.placerOrderNumber) : '-';
            const authoredOn = child.authoredOn ? new Date(child.authoredOn).toLocaleDateString() : '-';
            const childPriority = child.priority || 'routine';
            const priorityBadge = `<span class="badge bg-${getPriorityBadgeColor(childPriority)}">${escapeHtml(childPriority)}</span>`;
            testsHtml += `
                <tr>
                    <td>${seqDisplay}</td>
                    <td><small>${ponDisplay}</small></td>
                    <td>${escapeHtml(child.codeDisplay || 'No test specified')}</td>
                    <td>${priorityBadge}</td>
                    <td><small>${authoredOn}</small></td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        });
        testsHtml += '</tbody></table>';
    } else {
        // Fallback to codes array display
        const codes = Array.isArray(sr.codes) ? sr.codes.filter(Boolean) : [];
        const fallbackDisplay = sr.code || sr.description || '';
        const displays = codes.length ? codes : (fallbackDisplay ? [fallbackDisplay] : []);
        
        console.log('Codes after filtering:', codes);
        console.log('Fallback display:', fallbackDisplay);
        console.log('Final displays array:', displays);
        
        testsHtml = displays.length
            ? `<ul class="mb-2">${displays.map(c => `<li>${escapeHtml(c)}</li>`).join('')}</ul>`
            : `<p class="text-muted mb-2">No requested tests provided.</p>`;
    }

    const identifier = formatIdentifier(task.patient_identifiers);
    const placer = sr.placer_group_number ? escapeHtml(sr.placer_group_number) : '-';
    const status = task.status ? escapeHtml(task.status) : 'unknown';
    const priority = task.priority || 'routine';
    const priorityBadge = `<span class="badge bg-${getPriorityBadgeColor(priority)}">${escapeHtml(priority)}</span>`;
    
    // Format business status as a tag
    const businessStatus = task.businessStatus || '';
    const businessStatusDisplay = businessStatus ? businessStatus.charAt(0).toUpperCase() + businessStatus.slice(1).replace(/-/g, ' ') : '';
    const businessStatusTag = businessStatus 
        ? `<span class="badge bg-info text-dark">${escapeHtml(businessStatusDisplay)}</span>` 
        : '<span class="text-muted">Not set</span>';
    
    // Format lastModified in local date/time
    const lastModified = task.lastModified ? new Date(task.lastModified).toLocaleString() : '-';

    detailsContent.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Task ID:</strong> ${escapeHtml(task.id)}</p>
                <p><strong>Patient:</strong> ${escapeHtml(task.patient_name || 'Unknown')}</p>
                <p><strong>Identifier:</strong> ${identifier}</p>
                <p><strong>Placer Group #:</strong> ${placer}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Status:</strong> ${status}</p>
                <p><strong>Business Status:</strong> ${businessStatusTag}</p>
                <p><strong>Priority:</strong> ${priorityBadge}</p>
                <p><strong>Last Modified:</strong> ${lastModified}</p>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">
                <p><strong>Requested Tests:</strong></p>
                ${testsHtml}
            </div>
        </div>
    `;

    detailsPanel.classList.remove('d-none');
    detailsPanel.scrollIntoView({ behavior: 'smooth' });
}

function closeDetails() {
    document.getElementById('detailsPanel').classList.add('d-none');
    currentDetailTaskId = null;
}

function showToast(type, title, message) {
    const toast = document.getElementById('statusToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastBody = document.getElementById('toastBody');
    
    toastTitle.textContent = title;
    toastBody.textContent = message;
    
    // Update toast styling based on type
    toast.className = 'toast';
    if (type === 'danger') {
        toast.classList.add('border-danger');
        toastTitle.style.color = '#dc3545';
    } else if (type === 'success') {
        toast.classList.add('border-success');
        toastTitle.style.color = '#198754';
    } else if (type === 'warning') {
        toast.classList.add('border-warning');
        toastTitle.style.color = '#ffc107';
    } else {
        toast.classList.add('border-info');
        toastTitle.style.color = '#0dcaf0';
    }
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Ensure showToast doesn't fail if Bootstrap is not available
if (typeof window.bootstrap === 'undefined') {
    const originalShowToast = showToast;
    showToast = function(type, title, message) {
        console.warn(`Toast (${type}): ${title} - ${message}`);
        // Fallback: just log to console
    };
}

function formatIdentifier(identifiers) {
    if (!identifiers) return '-';
    if (identifiers.ihi) return `IHI: ${escapeHtml(identifiers.ihi)}`;
    if (identifiers.medicare) return `Medicare: ${escapeHtml(identifiers.medicare)}`;
    if (identifiers.dva) return `DVA: ${escapeHtml(identifiers.dva)}`;
    return '-';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function saveFhirSettings() {
    const serverUrl = document.getElementById('fhirServerUrl').value;
    const username = document.getElementById('fhirUsername').value;
    const password = document.getElementById('fhirPassword').value;
    
    if (!serverUrl || !username || !password) {
        showToast('danger', 'Error', 'Please fill in all fields');
        return;
    }
    
    localStorage.setItem('fhirServerUrl', serverUrl);
    localStorage.setItem('fhirUsername', username);
    localStorage.setItem('fhirPassword', password);
    
    showToast('success', 'Settings Saved', 'FHIR server settings have been saved');
    bootstrap.Modal.getInstance(document.getElementById('fhirServerModal')).hide();
}

// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    const serverUrl = localStorage.getItem('fhirServerUrl');
    const username = localStorage.getItem('fhirUsername');
    const password = localStorage.getItem('fhirPassword');
    
    if (serverUrl) document.getElementById('fhirServerUrl').value = serverUrl;
    if (username) document.getElementById('fhirUsername').value = username;
    if (password) document.getElementById('fhirPassword').value = password;
});
</script>

<style>
    :root {
        --tropical-primary: #2E86AB;
        --tropical-secondary: #F18F01;
        --tropical-success: #5AAA95;
        --tropical-danger: #E63946;
        --tropical-info: #5BC0BE;
        --tropical-light: #FEF9EF;
        --tropical-dark: #293241;
    }
    
    /* Match dashboard card styling */
    .card {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border: none;
        margin-bottom: 1.5rem;
    }
    
    .card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
        padding: 1rem 1.25rem;
        border-bottom: none;
    }
    
    .card-header.bg-primary {
        background-color: var(--tropical-primary) !important;
    }
    
    .card-header.bg-info {
        background-color: var(--tropical-info) !important;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    .card-footer {
        background-color: rgba(0, 0, 0, 0.02);
        padding: 1rem 1.25rem;
    }
    
    /* Form styling */
    .form-select, .form-control {
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }
    
    .form-select:focus, .form-control:focus {
        border-color: var(--tropical-primary);
        box-shadow: 0 0 0 0.2rem rgba(46, 134, 171, 0.25);
    }
    
    /* Table styling */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .table-primary {
        background-color: #e7f1f8 !important;
        font-weight: 500;
    }
    
    /* Pagination styling */
    .pagination .page-link {
        border-radius: 6px;
        margin: 0 2px;
        color: var(--tropical-primary);
    }
    
    .pagination .page-link:hover {
        background-color: #e7f1f8;
        color: var(--tropical-primary);
    }
    
    .pagination .page-link:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    /* Toast styling */
    .toast {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    #statusToast {
        min-width: 350px;
    }
    
    /* Loader visibility - hide by default */
    #orgLoader, #tableLoader {
        display: none !important;
    }
    
    /* Page heading */
    h1 {
        color: var(--tropical-dark);
        font-weight: 700;
        margin-bottom: 1.5rem;
    }
</style>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FHIR Settings Modal -->
    <div class="modal fade" id="fhirServerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">FHIR Server Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fhirServerUrl" class="form-label">FHIR Server URL</label>
                        <input type="url" class="form-control" id="fhirServerUrl" placeholder="https://example.com/fhir">
                    </div>
                    <div class="mb-3">
                        <label for="fhirUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="fhirUsername">
                    </div>
                    <div class="mb-3">
                        <label for="fhirPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="fhirPassword">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveFhirSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
</main>
</body>
</html>
