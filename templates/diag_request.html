<!-- Diagnostic Request Modal -->
<div class="modal fade" id="createDiagnosticRequestModal" tabindex="-1" aria-labelledby="createDiagnosticRequestLabel" aria-hidd        <!-- Copy To (Recipients) -->
        <div class="mb-3">
            <label for="copyTo" class="form-label">Copy Results To</label>
            <select class="form-select" id="copyToList" name="copyTo" multiple
                    hx-get="/fhir/CopyToPractitioners"
                    hx-trigger="shown.bs.modal from:#createDiagnosticRequestModal"
                    hx-target="#copyToList"
                    hx-swap="outerHTML">
              <option value="">Select practitioners to copy results to...</option>
              <!-- Options will be loaded here by HTMX -->
            </select>
            <div class="form-text">Hold Ctrl (or Cmd on Mac) to select multiple practitioners</div>
        </div><div class="modal-dialog">
    <div class="modal-content">
      <form id="diagnosticRequestForm"
            hx-post="/fhir/diagnosticrequest/bundler/{{ patient.id }}" 
            hx-trigger="submit"
            hx-target="#jsonData"
            hx-swap="outerHTML"
            hx-indicator="#jsonData-spinner"
            hx-on="htmx:afterRequest: if (event.detail.successful) { closeDialog(); }">
        <div class="modal-header">
          <h5 class="modal-title" id="createDiagnosticRequestLabel">Diagnostic Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Requester Dropdown -->
          <div class="mb-3" id="requesterDropdownContainer">
            <label for="requesterList" class="form-label">Select Requester</label>
            <select class="form-select" id="requesterList" name="requester" required
                    hx-get="/fhir/Requesters"
                    hx-trigger="shown.bs.modal from:#createDiagnosticRequestModal"
                    hx-target="#requesterList"
                    hx-swap="outerHTML">
              <option value="">Select a requester...</option>
              <!-- Options will be loaded here by HTMX -->
            </select>
          </div>
          <!-- get patient id from the session -->
          <input type="hidden" name="patient_id" value="{{ session.current_patient_id }}">    
          <!-- Diagnostic Request Category Radio Buttons -->
          <div class="mb-3">
            <label class="form-label" id="requestCategoryLabel">Request Category</label>
            <div role="radiogroup" aria-labelledby="requestCategoryLabel">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestCategory" id="pathologyRequest" value="Pathology" required checked>
                <label class="form-check-label" for="pathologyRequest">Pathology Request</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestCategory" id="radiologyRequest" value="Radiology" required>
                <label class="form-check-label" for="radiologyRequest">Radiology Request</label>
              </div>
            </div>          
          </div>
          <!-- Provider Organisation Dropdown (shown/updated based on Request Category) -->
          <div class="mb-3" id="providerDropdownContainer">
            <label for="organisationList" class="form-label">Select Provider Organisation</label>
            <select class="form-select" id="organisationList" name="organisation">
              <option value="">Select an provider...</option>
              <!-- Options will be loaded here by HTMX -->
            </select>
          </div>
          <div class="mb-3">
            <label for="testName" class="form-label">Test Name</label>
            <input 
                type="search" 
                class="form-control" 
                id="testName" 
                name="testName" 
                placeholder="start typing the test name..." 
                autocomplete="off"                
                hx-get="/fhir/diagvalueset/expand"
                hx-trigger="input changed delay:500ms, keyup[!event.shiftKey && event.key=='Tab'] from:#testName, change from:input[name='requestCategory']"
                hx-target="#testNameList"
                hx-include="closest form"
                hx-swap="innerHTML"
                hx-indicator="#testName-indicator"
                list="testNameList"
            >
            <datalist id="testNameList"></datalist>
            <div id="testName-indicator" class="htmx-indicator">
                <small class="text-muted">Searching...</small>
            </div>
            
            <!-- Specimen Collection Checkbox (shown only for Pathology) -->
            <div id="specimenCheckboxSection" class="mb-3" style="display: none;">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="specimenCollected" name="specimenCollected" value="true">
                    <label class="form-check-label" for="specimenCollected">
                        <strong>Specimen collected?</strong>
                    </label>
                    <div class="form-text">Check this box if a specimen was collected for this pathology request.</div>
                </div>
            </div>
            
            <!-- If Pathology is requested add the option to include a Specimen resource in the bundle. Include Specimen type,
                  collection method and body site
                  e.g. Specimen.type = Swab,
                       Specimen.collection.method = 285570007|Taking of swab| ,
                       Specimen.collection.bodySite = 48979004 | Left lower leg |
             Ensure the Specimen type is selected from the https://healthterminologies.gov.au/fhir/ValueSet/specimen-type-1 ValueSet, 
             Collection procedure is selected from https://healthterminologies.gov.au/fhir/ValueSet/specimen-collection-procedure-1
             and site is selected from https://healthterminologies.gov.au/fhir/ValueSet/body-site-1
             collectedDateTime can be the current date time.
          --> 
          <!-- Specimen Collection Section (shown only for Pathology) -->
          <div id="specimenSection" class="mb-3" style="display: none;">
            <label class="form-label">Specimen Collection Details</label>
            <div class="card p-3">
              <div class="row">
                <!-- Specimen Type -->
                <div class="col-md-4 mb-3">
                  <label for="specimenType" class="form-label">Specimen Type</label>
                  <input 
                    type="search" 
                    class="form-control" 
                    id="specimenType" 
                    name="specimenType" 
                    placeholder="e.g. Blood, Urine, Swab..." 
                    autocomplete="off"
                    hx-get="/fhir/specimentype/expand"
                    hx-trigger="input changed delay:500ms"
                    hx-target="#specimenTypeList"
                    hx-swap="innerHTML"
                    hx-indicator="#specimenType-indicator"
                    list="specimenTypeList"
                  >
                  <datalist id="specimenTypeList"></datalist>
                  <div id="specimenType-indicator" class="htmx-indicator">
                    <small class="text-muted">Searching...</small>
                  </div>
                  <input type="hidden" id="specimenTypeCode" name="specimenTypeCode">
                  <input type="hidden" id="specimenTypeDisplay" name="specimenTypeDisplay">
                </div>
                
                <!-- Collection Method -->
                <div class="col-md-4 mb-3">
                  <label for="collectionMethod" class="form-label">Collection Method</label>
                  <input 
                    type="search" 
                    class="form-control" 
                    id="collectionMethod" 
                    name="collectionMethod" 
                    placeholder="e.g. Venipuncture, Swab..." 
                    autocomplete="off"
                    hx-get="/fhir/collectionmethod/expand"
                    hx-trigger="input changed delay:500ms"
                    hx-target="#collectionMethodList"
                    hx-swap="innerHTML"
                    hx-indicator="#collectionMethod-indicator"
                    list="collectionMethodList"
                  >
                  <datalist id="collectionMethodList"></datalist>
                  <div id="collectionMethod-indicator" class="htmx-indicator">
                    <small class="text-muted">Searching...</small>
                  </div>
                  <input type="hidden" id="collectionMethodCode" name="collectionMethodCode">
                  <input type="hidden" id="collectionMethodDisplay" name="collectionMethodDisplay">
                </div>
                
                <!-- Body Site -->
                <div class="col-md-4 mb-3">
                  <label for="bodySite" class="form-label">Body Site</label>
                  <input 
                    type="search" 
                    class="form-control" 
                    id="bodySite" 
                    name="bodySite" 
                    placeholder="e.g. Left arm, Throat..." 
                    autocomplete="off"
                    hx-get="/fhir/bodysite/expand"
                    hx-trigger="input changed delay:500ms"
                    hx-target="#bodySiteList"
                    hx-swap="innerHTML"
                    hx-indicator="#bodySite-indicator"
                    list="bodySiteList"
                  >
                  <datalist id="bodySiteList"></datalist>
                  <div id="bodySite-indicator" class="htmx-indicator">
                    <small class="text-muted">Searching...</small>
                  </div>
                  <input type="hidden" id="bodySiteCode" name="bodySiteCode">
                  <input type="hidden" id="bodySiteDisplay" name="bodySiteDisplay">
                </div>
              </div>
              
              <!-- Collection Date/Time -->
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="collectionDateTime" class="form-label">Collection Date & Time</label>
                  <input 
                    type="datetime-local" 
                    class="form-control" 
                    id="collectionDateTime" 
                    name="collectionDateTime"
                  >
                  <div class="form-text">Leave blank to use current date/time</div>
                </div>
              </div>
            </div>
          </div>
             <!-- Hidden field to store selected tests as tags -->
            <input type="hidden" id="selectedTests" name="selectedTests">
            <div id="selectedTestsDisplay" class="mt-2"></div>
          </div>
          <!--Non-fasting/fasting default to non-fasting-->
          <div class="mb-3 mt-3">
          <label class="form-label" id="fastingLabel">Fasting Status</label>
          <div role="radiogroup" aria-labelledby="fastingLabel">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="fastingStatus" id="nonFasting" value="Non-fasting" checked>
              <label class="form-check-label" for="nonFasting">Non-fasting</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="fastingStatus" id="fasting" value="Fasting">
              <label class="form-check-label" for="fasting">Fasting</label>
            </div>
          </div>
          <!-- Request priority routine | urgent | asap | stat , default to routine -->
          <div class="mb-3 mt-3">
            <label class="form-label" id="priorityLabel">Request Priority</label>
            <div role="radiogroup" aria-labelledby="priorityLabel">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestPriority" id="routinePriority" value="routine" checked>
                <label class="form-check-label" for="routinePriority">Routine</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestPriority" id="urgentPriority" value="urgent">
                <label class="form-check-label" for="urgentPriority">Urgent</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestPriority" id="asapPriority" value="asap">
                <label class="form-check-label" for="asapPriority">ASAP</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestPriority" id="statPriority" value="stat">
                <label class="form-check-label" for="statPriority">STAT</label>
              </div>
            </div>
          </div>
           
        <!-- Pregnancy status-->
        <div class="mb-3 mt-3">
          <div class="form-check-group">          
            <label class="form-label" id="pregnantStatusLabel">Pregnant Status</label>
            <div class="form-check" aria-labelledby="pregnantStatusLabel">
              <input class="form-check-input" type="checkbox" id="pregnantStatus" name="isPregnant" value="true">
              <label class="form-check-label" for="pregnantStatus">
                Patient is pregnant
              </label>
            </div>
          </div>
        </div>
        <!-- My Health Record consent withdrawal -->
        <div class="mb-3 mt-3">
          <div class="form-check-group"> 
            <label class="form-label" id="mhrConsentLabel">My Health Record Upload Consent</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="mhrConsentWithdrawn" name="mhrConsentWithdrawn" value="true">
              <label class="form-check-label" for="mhrConsentWithdrawn">
                Do not upload results to My Health Record 
              </label>
            </div>
          </div>
        </div>
        <!-- Request Status -->
        <div class="mb-3 mt-3">
          <label class="form-label" id="requestStatusLabel">Request Status</label>
          <div role="radiogroup" aria-labelledby="requestStatusLabel">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="requestStatus" id="requestStatusActive" value="active" checked>
              <label class="form-check-label" for="requestStatusActive">Active</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="requestStatus" id="requestStatusOnHold" value="on-hold">
              <label class="form-check-label" for="requestStatusOnHold">On-Hold</label>
            </div>
          </div>
        </div>
        <!-- Status Reason (only shown when status is on-hold) -->
        <div class="mb-3 mt-3" id="statusReasonContainer" style="display: none;">
          <label for="statusReason" class="form-label">Status Reason</label>
          <textarea class="form-control" id="statusReason" name="statusReason" rows="2" placeholder="Enter reason for putting request on hold..."></textarea>
          <div class="form-text">Explain why this request is being placed on hold</div>
        </div>
        <!-- Billing category -->
        <div class="mb-3 mt-3">
          <label class="form-label" id="billingCategoryLabel">Billing Category</label>
          <div role="radiogroup" aria-labelledby="billingCategoryLabel">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingMedicare" value="PUBLICPOL" checked>
              <label class="form-check-label" for="billingMedicare">Medicare</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingDVA" value="VET">
              <label class="form-check-label" for="billingDVA">Department of Veterans' Affairs</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingPrivate" value="pay">
              <label class="form-check-label" for="billingPrivate">Private Pay</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingPrivateConcession" value="payconc">
              <label class="form-check-label" for="billingPrivateConcession">Private Pay with Concession</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingPublicHospital" value="AUPUBHOSP">
              <label class="form-check-label" for="billingPublicHospital">Public Hospital</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingWorkcover" value="WCBPOL">
              <label class="form-check-label" for="billingWorkcover">Workers' Compensation</label>
            </div>
          </div>
        </div> 
        <!-- Reason for request Searchbox-->
        <div class="mb-3">
            <label for="reason" class="form-label">Reason for Request</label>
            <input 
                type="search" 
                class="form-control" 
                id="reason" 
                name="reason" 
                placeholder="start typing the reason..." 
                autocomplete="off"
                hx-get="/fhir/reasonvalueset/expand"
                hx-trigger="input changed delay:500ms, keyup[!event.shiftKey && event.key=='Tab'] from:#reason"
                hx-target="#reasonList"
                hx-include="closest form"
                hx-swap="innerHTML"
                hx-indicator="#reason-indicator"
                list="reasonList"
            >
            <datalist id="reasonList"></datalist>
            <div id="reason-indicator" class="htmx-indicator">
                <small class="text-muted">Searching...</small>
            </div>

             <!-- Hidden field to store selected tests as tags -->
            <input type="hidden" id="selectedReasons" name="selectedReasons">
            <div id="selectedReasonsDisplay" class="mt-2"></div>
          </div> 
        <!-- Copy To (Recipients) -->
        <div class="mb-3">
            <label for="copyToPractitioner" class="form-label">Copy Results To</label>
            <input 
                type="search" 
                class="form-control" 
                id="copyToPractitioner" 
                name="copyToPractitioner" 
                placeholder="start typing practitioner name..." 
                autocomplete="off"
                hx-get="/fhir/CopyToPractitioners"
                hx-trigger="input changed delay:500ms, keyup[!event.shiftKey && event.key=='Tab'] from:#copyToPractitioner"
                hx-target="#copyToPractitionerList"
                hx-include="closest form"
                hx-swap="innerHTML"
                hx-indicator="#copyToPractitioner-indicator"
                list="copyToPractitionerList"
            >
            <datalist id="copyToPractitionerList"></datalist>
            <div id="copyToPractitioner-indicator" class="htmx-indicator">
                <small class="text-muted">Searching...</small>
            </div>

             <!-- Hidden field to store selected practitioners as array -->
            <input type="hidden" id="copyTo" name="copyTo">
            <div id="copyToPractitionersDisplay" class="mt-2"></div>
        </div>
        <!-- Clinical context --> 
        </div>
          <div class="mb-3 mt-3">
            <label for="clinicalContext" class="form-label">Clinical Context for Request</label>
            <textarea class="form-control" id="clinicalContext" name="clinicalContext" rows="3"></textarea>
          </div>
          
          <!-- Add narrative toggle -->
          <div class="mb-3 mt-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="addNarrative" name="addNarrative" value="true">
              <label class="form-check-label" for="addNarrative">
                Add narrative text to all resources in the bundle
              </label>
            </div>            
          </div>
        </div>  
        <!-- Add narative slider--> 

        <!-- Submit Request bundle-->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" onclick="setTimeout(closeDialog, 100)">Submit Request</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
window.selectedTests = Array.isArray(window.selectedTests) ? window.selectedTests : [];

function renderSelectedTests() {
    const display = document.getElementById('selectedTestsDisplay');
    const hidden = document.getElementById('selectedTests');
    display.innerHTML = window.selectedTests.map((test, idx) =>
        `<span class="badge bg-info text-dark me-1 mb-1">
            ${typeof test === 'string' ? test : test.display}
            <button type="button" class="btn-close btn-close-white btn-sm ms-1" aria-label="Remove" onclick="removeTest(${idx})" style="font-size:0.7em; vertical-align:middle;"></button>
        </span>`
    ).join('');
    hidden.value = JSON.stringify(window.selectedTests);
}

function addTestSelection() {
    const input = document.getElementById('testName');
    const value = input.value.trim();
    if (value && Array.isArray(window.selectedTests)) {
        // Check if we already have this test (by display name)
        const existingTest = window.selectedTests.find(test => 
            (typeof test === 'string' ? test : test.display) === value
        );
        
        if (!existingTest) {
            // Try to find the corresponding option in the datalist to get the code
            const datalist = document.getElementById('testNameList');
            const options = datalist.querySelectorAll('option');
            let testCode = '';
            
            for (let option of options) {
                if (option.value === value) {
                    testCode = option.getAttribute('data-code') || '';
                    break;
                }
            }
            
            // Store as object with code, display, and display_sequence
            // The sequence is 1-indexed based on the order of addition
            window.selectedTests.push({
                code: testCode,
                display: value,
                display_sequence: window.selectedTests.length + 1
            });
            renderSelectedTests();
            input.value = '';
        }
    }
}

function removeTest(idx) {
    if (Array.isArray(window.selectedTests)) {
        window.selectedTests.splice(idx, 1);
        // Recalculate display_sequence for remaining tests to maintain consecutive numbering
        window.selectedTests.forEach((test, index) => {
            if (typeof test === 'object') {
                test.display_sequence = index + 1;
            }
        });
        renderSelectedTests();
    }
}

// Add test on Enter, Tab, or when a datalist option is picked
document.getElementById('testName').addEventListener('change', addTestSelection);
document.getElementById('testName').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === 'Tab') {
        setTimeout(addTestSelection, 10);
    }
});

// Clear testName and selectedTests when requestCategory changes
document.querySelectorAll('input[name="requestCategory"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('testName').value = '';
        window.selectedTests = [];
        renderSelectedTests();
    });
});

// Blur close button on modal close to avoid aria-hidden accessibility warning
document.querySelectorAll('.btn-close[data-bs-dismiss="modal"]').forEach(btn => {
    btn.addEventListener('click', function() {
        this.blur();
    });
});

// Reason for Request
window.selectedReasons = Array.isArray(window.selectedReasons) ? window.selectedReasons : [];

function renderSelectedReasons() {
    const display = document.getElementById('selectedReasonsDisplay');
    const hidden = document.getElementById('selectedReasons');
    display.innerHTML = window.selectedReasons.map((reason, idx) =>
        `<span class="badge bg-secondary text-dark me-1 mb-1">
            ${typeof reason === 'string' ? reason : reason.display}
            <button type="button" class="btn-close btn-close-white btn-sm ms-1" aria-label="Remove" onclick="removeReason(${idx})" style="font-size:0.7em; vertical-align:middle;"></button>
        </span>`
    ).join('');
    hidden.value = JSON.stringify(window.selectedReasons);
}

function addReasonSelection() {
    const input = document.getElementById('reason');
    const value = input.value.trim();
    if (value && Array.isArray(window.selectedReasons)) {
        // Check if we already have this reason (by display name)
        const existingReason = window.selectedReasons.find(reason => 
            (typeof reason === 'string' ? reason : reason.display) === value
        );
        
        if (!existingReason) {
            // Try to find the corresponding option in the datalist to get the code
            const datalist = document.getElementById('reasonList');
            const options = datalist.querySelectorAll('option');
            let reasonCode = '';
            
            for (let option of options) {
                if (option.value === value) {
                    reasonCode = option.getAttribute('data-code') || '';
                    break;
                }
            }
            
            // Store as object with code and display
            window.selectedReasons.push({
                code: reasonCode,
                display: value
            });
            renderSelectedReasons();
            input.value = '';
        }
    }
}

function removeReason(idx) {
    if (Array.isArray(window.selectedReasons)) {
        window.selectedReasons.splice(idx, 1);
        renderSelectedReasons();
    }
}

// Copy To Practitioners
window.selectedCopyToPractitioners = Array.isArray(window.selectedCopyToPractitioners) ? window.selectedCopyToPractitioners : [];

function renderSelectedCopyToPractitioners() {
    const display = document.getElementById('copyToPractitionersDisplay');
    const hidden = document.getElementById('copyTo');
    display.innerHTML = window.selectedCopyToPractitioners.map((practitioner, idx) =>
        `<span class="badge bg-warning text-dark me-1 mb-1">
            ${typeof practitioner === 'string' ? practitioner : practitioner.display}
            <button type="button" class="btn-close btn-close-white btn-sm ms-1" aria-label="Remove" onclick="removeCopyToPractitioner(${idx})" style="font-size:0.7em; vertical-align:middle;"></button>
        </span>`
    ).join('');
    // Store only the IDs in the hidden field for form submission
    const practitionerIds = window.selectedCopyToPractitioners.map(practitioner => 
        typeof practitioner === 'string' ? practitioner : practitioner.id
    );
    hidden.value = JSON.stringify(practitionerIds);
}

function addCopyToPractitionerSelection() {
    const input = document.getElementById('copyToPractitioner');
    const value = input.value.trim();
    if (value && Array.isArray(window.selectedCopyToPractitioners)) {
        // Check if we already have this practitioner (by display name)
        const existingPractitioner = window.selectedCopyToPractitioners.find(practitioner => 
            (typeof practitioner === 'string' ? practitioner : practitioner.display) === value
        );
        
        if (!existingPractitioner) {
            // Try to find the corresponding option in the datalist to get the ID
            const datalist = document.getElementById('copyToPractitionerList');
            const options = datalist.querySelectorAll('option');
            let practitionerId = '';
            
            for (let option of options) {
                if (option.value === value) {
                    practitionerId = option.getAttribute('data-code') || '';
                    break;
                }
            }
            
            // Store as object with id and display
            window.selectedCopyToPractitioners.push({
                id: practitionerId,
                display: value
            });
            renderSelectedCopyToPractitioners();
            input.value = '';
        }
    }
}

function removeCopyToPractitioner(idx) {
    if (Array.isArray(window.selectedCopyToPractitioners)) {
        window.selectedCopyToPractitioners.splice(idx, 1);
        renderSelectedCopyToPractitioners();
    }
}

// Show and load provider organisations based on Request Category
function updateProviderDropdown() {
    const pathologyRadio = document.getElementById('pathologyRequest');
    const radiologyRadio = document.getElementById('radiologyRequest');
    const orgList = document.getElementById('organisationList');
    const specimenSection = document.getElementById('specimenSection');
    const specimenCheckboxSection = document.getElementById('specimenCheckboxSection');
    let snomedCode = null;

    if (pathologyRadio.checked) {
        snomedCode = '310074003';
        // Show specimen checkbox section for pathology
        if (specimenCheckboxSection) {
            specimenCheckboxSection.style.display = 'block';
        }
        // Update specimen section visibility based on checkbox
        updateSpecimenSectionVisibility();
    } else if (radiologyRadio.checked) {
        snomedCode = '708175003';
        // Hide specimen sections for radiology
        if (specimenCheckboxSection) {
            specimenCheckboxSection.style.display = 'none';
        }
        if (specimenSection) {
            specimenSection.style.display = 'none';
        }
    }

    if (snomedCode) {
        // Load organisations for the selected SNOMED code
        htmx.ajax('GET', `/fhir/Provider/${snomedCode}`, '#providerDropdownContainer');
    } else {
        orgList.innerHTML = '<option value="">Select an provider...</option>';
    }
}

function updateSpecimenSectionVisibility() {
    const specimenCollectedCheckbox = document.getElementById('specimenCollected');
    const specimenSection = document.getElementById('specimenSection');
    const pathologyRadio = document.getElementById('pathologyRequest');
    
    // Only show specimen section if pathology is selected AND checkbox is checked
    if (pathologyRadio && pathologyRadio.checked && specimenCollectedCheckbox && specimenCollectedCheckbox.checked) {
        if (specimenSection) {
            specimenSection.style.display = 'block';
        }
    } else {
        if (specimenSection) {
            specimenSection.style.display = 'none';
        }
    }
}

// Attach event listeners to Request Category radios
document.getElementById('pathologyRequest').addEventListener('change', updateProviderDropdown);
document.getElementById('radiologyRequest').addEventListener('change', updateProviderDropdown);

// Attach event listener to specimen collection checkbox
document.getElementById('specimenCollected').addEventListener('change', updateSpecimenSectionVisibility);

// Attach event listeners to requestingContext radios
document.querySelectorAll('input[name="requestingContext"]').forEach(radio => {
    radio.addEventListener('change', updateSpecialistDropdown);
});

// Add reason on Enter, Tab, or when a datalist option is picked
document.getElementById('reason').addEventListener('change', addReasonSelection);
document.getElementById('reason').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === 'Tab') {
        setTimeout(addReasonSelection, 10);
    }
});

// Add copyTo practitioner on Enter, Tab, or when a datalist option is picked
document.getElementById('copyToPractitioner').addEventListener('change', addCopyToPractitionerSelection);
document.getElementById('copyToPractitioner').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === 'Tab') {
        setTimeout(addCopyToPractitionerSelection, 10);
    }
});

// Handle Request Status toggle to show/hide status reason field
function updateStatusReasonVisibility() {
    const onHoldRadio = document.getElementById('requestStatusOnHold');
    const statusReasonContainer = document.getElementById('statusReasonContainer');
    const statusReasonField = document.getElementById('statusReason');
    
    if (onHoldRadio.checked) {
        statusReasonContainer.style.display = 'block';
        statusReasonField.required = true;
    } else {
        statusReasonContainer.style.display = 'none';
        statusReasonField.required = false;
        statusReasonField.value = ''; // Clear the field when hiding
    }
}

// Attach event listeners to Request Status radios
document.getElementById('requestStatusActive').addEventListener('change', updateStatusReasonVisibility);
document.getElementById('requestStatusOnHold').addEventListener('change', updateStatusReasonVisibility);

// Reset selectedTests and selectedReasons when the modal is opened
document.getElementById('createDiagnosticRequestModal').addEventListener('shown.bs.modal', function () {
  // initialise Provider list
    updateProviderDropdown(); 

  // Clear selected tests
    window.selectedTests = [];
    renderSelectedTests();

    // Clear selected reasons
    window.selectedReasons = [];
    renderSelectedReasons();

    // Clear selected copyTo practitioners
    window.selectedCopyToPractitioners = [];
    renderSelectedCopyToPractitioners();

    // Clear input fields
    document.getElementById('testName').value = '';
    document.getElementById('reason').value = '';
    document.getElementById('copyToPractitioner').value = '';
    
    // Reset request status to active and hide status reason field
    document.getElementById('requestStatusActive').checked = true;
    document.getElementById('requestStatusOnHold').checked = false;
    updateStatusReasonVisibility();
    
    // Clear specimen fields
    document.getElementById('specimenType').value = '';
    document.getElementById('specimenTypeCode').value = '';
    document.getElementById('specimenTypeDisplay').value = '';
    document.getElementById('collectionMethod').value = '';
    document.getElementById('collectionMethodCode').value = '';
    document.getElementById('collectionMethodDisplay').value = '';
    document.getElementById('bodySite').value = '';
    document.getElementById('bodySiteCode').value = '';
    document.getElementById('bodySiteDisplay').value = '';
    
    // Set default collection date/time to current time
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    
    const collectionDateTimeInput = document.getElementById('collectionDateTime');
    if (collectionDateTimeInput) {
        collectionDateTimeInput.value = localDateTime;
    }
});

function closeDialog() {
    let modalEl = document.getElementById('createDiagnosticRequestModal');
    let modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
    modalInstance.hide();
    console.log('modal should be hidden now...')
}

// Function to capture SNOMED codes for specimen fields
function captureSpecimenCode(inputId, codeFieldId, displayFieldId) {
    const input = document.getElementById(inputId);
    const codeField = document.getElementById(codeFieldId);
    const displayField = document.getElementById(displayFieldId);
    const value = input.value.trim();
    
    if (value) {
        // Find the corresponding option in the datalist to get the code
        const datalistId = input.getAttribute('list');
        const datalist = document.getElementById(datalistId);
        const options = datalist.querySelectorAll('option');
        
        let foundCode = '';
        for (let option of options) {
            if (option.value === value) {
                foundCode = option.getAttribute('data-code') || '';
                break;
            }
        }
        
        // Store both code and display
        if (codeField) codeField.value = foundCode;
        if (displayField) displayField.value = value;
        
        console.log(`Captured ${inputId}: code="${foundCode}", display="${value}"`);
    } else {
        // Clear if empty
        if (codeField) codeField.value = '';
        if (displayField) displayField.value = '';
    }
}

// Add event listeners for specimen fields
document.addEventListener('DOMContentLoaded', function() {
    // Specimen Type
    const specimenTypeInput = document.getElementById('specimenType');
    if (specimenTypeInput) {
        specimenTypeInput.addEventListener('change', function() {
            captureSpecimenCode('specimenType', 'specimenTypeCode', 'specimenTypeDisplay');
        });
        specimenTypeInput.addEventListener('blur', function() {
            captureSpecimenCode('specimenType', 'specimenTypeCode', 'specimenTypeDisplay');
        });
    }
    
    // Collection Method
    const collectionMethodInput = document.getElementById('collectionMethod');
    if (collectionMethodInput) {
        collectionMethodInput.addEventListener('change', function() {
            captureSpecimenCode('collectionMethod', 'collectionMethodCode', 'collectionMethodDisplay');
        });
        collectionMethodInput.addEventListener('blur', function() {
            captureSpecimenCode('collectionMethod', 'collectionMethodCode', 'collectionMethodDisplay');
        });
    }
    
    // Body Site
    const bodySiteInput = document.getElementById('bodySite');
    if (bodySiteInput) {
        bodySiteInput.addEventListener('change', function() {
            captureSpecimenCode('bodySite', 'bodySiteCode', 'bodySiteDisplay');
        });
        bodySiteInput.addEventListener('blur', function() {
            captureSpecimenCode('bodySite', 'bodySiteCode', 'bodySiteDisplay');
        });
    }
});
</script>