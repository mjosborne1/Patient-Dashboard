<!-- Diagnostic Request Modal -->
<div class="modal fade" id="createDiagnosticRequestModal" tabindex="-1" aria-labelledby="createDiagnosticRequestLabel" aria-hidd        <!-- Copy To (Recipients) -->
        <div class="mb-3">
            <label for="copyTo" class="form-label">Copy Results To</label>
            <select class="form-select" id="copyToList" name="copyTo" multiple
                    hx-get="/fhir/CopyToPractitioners"
                    hx-trigger="shown.bs.modal from:#createDiagnosticRequestModal"
                    hx-target="#copyToList"
                    hx-swap="outerHTML">
              <option value="">Select practitioners to copy results to...</option>
              <!-- Options will be loaded here by HTMX -->
            </select>
            <div class="form-text">Hold Ctrl (or Cmd on Mac) to select multiple practitioners</div>
        </div><div class="modal-dialog">
    <div class="modal-content">
      <form id="diagnosticRequestForm"
            hx-post="/fhir/diagnosticrequest/bundler/{{ patient.id }}" 
            hx-trigger="submit"
            hx-target="#jsonData"
            hx-swap="outerHTML"
            hx-indicator="#jsonData-spinner"
            hx-on="htmx:afterRequest: if (event.detail.successful) { closeDialog(); }">
        <div class="modal-header">
          <h5 class="modal-title" id="createDiagnosticRequestLabel">Diagnostic Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Requester Dropdown -->
          <div class="mb-3" id="requesterDropdownContainer">
            <label for="requesterList" class="form-label">Select Requester</label>
            <select class="form-select" id="requesterList" name="requester" required
                    hx-get="/fhir/Requesters"
                    hx-trigger="shown.bs.modal from:#createDiagnosticRequestModal"
                    hx-target="#requesterList"
                    hx-swap="outerHTML">
              <option value="">Select a requester...</option>
              <!-- Options will be loaded here by HTMX -->
            </select>
          </div>
          <!-- get patient id from the session -->
          <input type="hidden" name="patient_id" value="{{ session.current_patient_id }}">    
          <!-- Diagnostic Request Category Radio Buttons -->
          <div class="mb-3">
            <label class="form-label" id="requestCategoryLabel">Request Category</label>
            <div role="radiogroup" aria-labelledby="requestCategoryLabel">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestCategory" id="pathologyRequest" value="Pathology" required checked>
                <label class="form-check-label" for="pathologyRequest">Pathology Request</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestCategory" id="radiologyRequest" value="Radiology" required>
                <label class="form-check-label" for="radiologyRequest">Radiology Request</label>
              </div>
            </div>          
          </div>
          <!-- Provider Organisation Dropdown (shown/updated based on Request Category) -->
          <div class="mb-3" id="providerDropdownContainer">
            <label for="organisationList" class="form-label">Select Provider Organisation</label>
            <select class="form-select" id="organisationList" name="organisation">
              <option value="">Select an provider...</option>
              <!-- Options will be loaded here by HTMX -->
            </select>
          </div>
          <div class="mb-3">
            <label for="testName" class="form-label">Test Name</label>
            <div class="position-relative">
                <input 
                    type="search" 
                    class="form-control" 
                    id="testName" 
                    name="testName" 
                    placeholder="start typing the test name..." 
                    autocomplete="off"                
                    hx-get="/fhir/diagvalueset/expand"
                    hx-trigger="input changed delay:500ms, keyup[!event.shiftKey && event.key=='Tab'] from:#testName, change from:input[name='requestCategory']"
                    hx-target="#testNameDropdown"
                    hx-include="closest form"
                    hx-swap="innerHTML"
                    hx-indicator="#testName-indicator"
                    style="padding-right: 40px;"
                >
                <div id="testName-indicator" class="htmx-indicator position-absolute" style="right: 35px; top: 8px;">
                    <small class="text-muted">Searching...</small>
                </div>
                
                <!-- Clear button for test name search -->
                <button type="button" class="btn-close position-absolute" id="clearTestName" style="right: 10px; top: 12px; font-size: 0.7em; display: none;" aria-label="Clear search" title="Clear search" onclick="clearTestNameSearch()"></button>
                
                <!-- Custom dropdown for test results -->
                <div id="testNameDropdown" class="dropdown-menu position-absolute w-100 mt-1" style="display: none; max-height: 200px; overflow-y: auto; z-index: 1050;"></div>
            </div>
            <div class="form-text">
                <i class="fas fa-info-circle"></i> Type to search for tests, then click on a result to add it as a tag
            </div>
            <div id="testName-results" class="mt-1" style="display: none;">
                <small class="text-success"><i class="fas fa-check-circle"></i> <span id="testName-count">0</span> tests found</small>
            </div>
            
            <!-- Hidden field to store selected tests as tags -->
            <input type="hidden" id="selectedTests" name="selectedTests">
            <div id="selectedTestsDisplay" class="mt-2"></div>
            
            <!-- Specimen Collection Checkbox (shown only for Pathology) -->
            <div id="specimenCheckboxSection" class="mb-3" style="display: none;">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="specimenCollected" name="specimenCollected" value="true">
                    <label class="form-check-label" for="specimenCollected">
                        <strong>Specimen collected?</strong>
                    </label>
                    <div class="form-text">Check this box if a specimen was collected for this pathology request.</div>
                </div>
            </div>
            
            <!-- If Pathology is requested add the option to include a Specimen resource in the bundle. Include Specimen type,
                  collection method and body site
                  e.g. Specimen.type = Swab,
                       Specimen.collection.method = 285570007|Taking of swab| ,
                       Specimen.collection.bodySite = 48979004 | Left lower leg |
             Ensure the Specimen type is selected from the https://healthterminologies.gov.au/fhir/ValueSet/specimen-type-1 ValueSet, 
             Collection procedure is selected from https://healthterminologies.gov.au/fhir/ValueSet/specimen-collection-procedure-1
             and site is selected from https://healthterminologies.gov.au/fhir/ValueSet/body-site-1
             collectedDateTime can be the current date time.
          --> 
          <!-- Specimen Collection Section (shown only for Pathology) -->
          <div id="specimenSection" class="mb-3" style="display: none;">
            <label class="form-label">Specimen Collection Details</label>
            <div class="card p-3">
              <div class="row">
                <!-- Specimen Type -->
                <div class="col-md-4 mb-3">
                  <label for="specimenType" class="form-label">Specimen Type</label>
                  <input 
                    type="search" 
                    class="form-control" 
                    id="specimenType" 
                    name="specimenType" 
                    placeholder="e.g. Blood, Urine, Swab..." 
                    autocomplete="off"
                    hx-get="/fhir/specimentype/expand"
                    hx-trigger="input changed delay:500ms"
                    hx-target="#specimenTypeList"
                    hx-swap="innerHTML"
                    hx-indicator="#specimenType-indicator"
                    list="specimenTypeList"
                  >
                  <datalist id="specimenTypeList"></datalist>
                  <div id="specimenType-indicator" class="htmx-indicator">
                    <small class="text-muted">Searching...</small>
                  </div>
                  <input type="hidden" id="specimenTypeCode" name="specimenTypeCode">
                  <input type="hidden" id="specimenTypeDisplay" name="specimenTypeDisplay">
                </div>
                
                <!-- Collection Method -->
                <div class="col-md-4 mb-3">
                  <label for="collectionMethod" class="form-label">Collection Method</label>
                  <input 
                    type="search" 
                    class="form-control" 
                    id="collectionMethod" 
                    name="collectionMethod" 
                    placeholder="e.g. Venipuncture, Swab..." 
                    autocomplete="off"
                    hx-get="/fhir/collectionmethod/expand"
                    hx-trigger="input changed delay:500ms"
                    hx-target="#collectionMethodList"
                    hx-swap="innerHTML"
                    hx-indicator="#collectionMethod-indicator"
                    list="collectionMethodList"
                  >
                  <datalist id="collectionMethodList"></datalist>
                  <div id="collectionMethod-indicator" class="htmx-indicator">
                    <small class="text-muted">Searching...</small>
                  </div>
                  <input type="hidden" id="collectionMethodCode" name="collectionMethodCode">
                  <input type="hidden" id="collectionMethodDisplay" name="collectionMethodDisplay">
                </div>
                
                <!-- Body Site -->
                <div class="col-md-4 mb-3">
                  <label for="bodySite" class="form-label">Body Site</label>
                  <input 
                    type="search" 
                    class="form-control" 
                    id="bodySite" 
                    name="bodySite" 
                    placeholder="e.g. Left arm, Throat..." 
                    autocomplete="off"
                    hx-get="/fhir/bodysite/expand"
                    hx-trigger="input changed delay:500ms"
                    hx-target="#bodySiteList"
                    hx-swap="innerHTML"
                    hx-indicator="#bodySite-indicator"
                    list="bodySiteList"
                  >
                  <datalist id="bodySiteList"></datalist>
                  <div id="bodySite-indicator" class="htmx-indicator">
                    <small class="text-muted">Searching...</small>
                  </div>
                  <input type="hidden" id="bodySiteCode" name="bodySiteCode">
                  <input type="hidden" id="bodySiteDisplay" name="bodySiteDisplay">
                </div>
              </div>
              
              <!-- Collection Date/Time -->
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="collectionDateTime" class="form-label">Collection Date & Time</label>
                  <input 
                    type="datetime-local" 
                    class="form-control" 
                    id="collectionDateTime" 
                    name="collectionDateTime"
                  >
                  <div class="form-text">Leave blank to use current date/time</div>
                </div>
              </div>
            </div>
          </div>
          <!--Non-fasting/fasting default to non-fasting-->
          <div class="mb-3 mt-3">
          <label class="form-label" id="fastingLabel">Fasting Status</label>
          <div role="radiogroup" aria-labelledby="fastingLabel">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="fastingStatus" id="nonFasting" value="Non-fasting" checked>
              <label class="form-check-label" for="nonFasting">Non-fasting</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="fastingStatus" id="fasting" value="Fasting">
              <label class="form-check-label" for="fasting">Fasting</label>
            </div>
          </div>
          <!-- Request priority routine | urgent | asap | stat , default to routine -->
          <div class="mb-3 mt-3">
            <label class="form-label" id="priorityLabel">Request Priority</label>
            <div role="radiogroup" aria-labelledby="priorityLabel">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestPriority" id="routinePriority" value="routine" checked>
                <label class="form-check-label" for="routinePriority">Routine</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestPriority" id="urgentPriority" value="urgent">
                <label class="form-check-label" for="urgentPriority">Urgent</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestPriority" id="asapPriority" value="asap">
                <label class="form-check-label" for="asapPriority">ASAP</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="requestPriority" id="statPriority" value="stat">
                <label class="form-check-label" for="statPriority">STAT</label>
              </div>
            </div>
          </div>
           
        <!-- Pregnancy status-->
        <div class="mb-3 mt-3">
          <div class="form-check-group">          
            <label class="form-label" id="pregnantStatusLabel">Pregnant Status</label>
            <div class="form-check" aria-labelledby="pregnantStatusLabel">
              <input class="form-check-input" type="checkbox" id="pregnantStatus" name="isPregnant" value="true">
              <label class="form-check-label" for="pregnantStatus">
                Patient is pregnant
              </label>
            </div>
          </div>
        </div>
        <!-- My Health Record consent withdrawal -->
        <div class="mb-3 mt-3">
          <div class="form-check-group"> 
            <label class="form-label" id="mhrConsentLabel">My Health Record Upload Consent</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="mhrConsentWithdrawn" name="mhrConsentWithdrawn" value="true">
              <label class="form-check-label" for="mhrConsentWithdrawn">
                Do not upload results to My Health Record 
              </label>
            </div>
          </div>
        </div>
        <!-- Request Status -->
        <div class="mb-3 mt-3">
          <label class="form-label" id="requestStatusLabel">Request Status</label>
          <div role="radiogroup" aria-labelledby="requestStatusLabel">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="requestStatus" id="requestStatusActive" value="active" checked>
              <label class="form-check-label" for="requestStatusActive">Active</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="requestStatus" id="requestStatusOnHold" value="on-hold">
              <label class="form-check-label" for="requestStatusOnHold">On-Hold</label>
            </div>
          </div>
        </div>
        <!-- Status Reason (only shown when status is on-hold) -->
        <div class="mb-3 mt-3" id="statusReasonContainer" style="display: none;">
          <label for="statusReason" class="form-label">Status Reason</label>
          <textarea class="form-control" id="statusReason" name="statusReason" rows="2" placeholder="Enter reason for putting request on hold..."></textarea>
          <div class="form-text">Explain why this request is being placed on hold</div>
        </div>
        <!-- Billing category -->
        <div class="mb-3 mt-3">
          <label class="form-label" id="billingCategoryLabel">Billing Category</label>
          <div role="radiogroup" aria-labelledby="billingCategoryLabel">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingMedicare" value="PUBLICPOL" checked>
              <label class="form-check-label" for="billingMedicare">Medicare</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingDVA" value="VET">
              <label class="form-check-label" for="billingDVA">Department of Veterans' Affairs</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingPrivate" value="pay">
              <label class="form-check-label" for="billingPrivate">Private Pay</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingPrivateConcession" value="payconc">
              <label class="form-check-label" for="billingPrivateConcession">Private Pay with Concession</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingPublicHospital" value="AUPUBHOSP">
              <label class="form-check-label" for="billingPublicHospital">Public Hospital</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="billingCategory" id="billingWorkcover" value="WCBPOL">
              <label class="form-check-label" for="billingWorkcover">Workers' Compensation</label>
            </div>
          </div>
        </div> 
        <!-- Reason for request Searchbox-->
        <div class="mb-3">
            <label for="reason" class="form-label">Reason for Request</label>
            <div class="position-relative">
                <input 
                    type="search" 
                    class="form-control" 
                    id="reason" 
                    name="reason" 
                    placeholder="start typing the reason..." 
                    autocomplete="off"
                    hx-get="/fhir/reasonvalueset/expand"
                    hx-trigger="input changed delay:500ms, keyup[!event.shiftKey && event.key=='Tab'] from:#reason"
                    hx-target="#reasonDropdown"
                    hx-include="closest form"
                    hx-swap="innerHTML"
                    hx-indicator="#reason-indicator"
                    style="padding-right: 40px;"
                >
                <div id="reason-indicator" class="htmx-indicator position-absolute" style="right: 35px; top: 8px;">
                    <small class="text-muted">Searching...</small>
                </div>
                
                <!-- Clear button for reason search -->
                <button type="button" class="btn-close position-absolute" id="clearReason" style="right: 10px; top: 12px; font-size: 0.7em; display: none;" aria-label="Clear search" title="Clear search" onclick="clearReasonSearch()"></button>
                
                <!-- Custom dropdown for reason results -->
                <div id="reasonDropdown" class="dropdown-menu position-absolute w-100 mt-1" style="display: none; max-height: 200px; overflow-y: auto; z-index: 1050;"></div>
            </div>
            <div class="form-text">
                <i class="fas fa-info-circle"></i> Type to search for reasons, click on a result to add it as a tag, or press Enter to add custom text
            </div>
            <div id="reason-results" class="mt-1" style="display: none;">
                <small class="text-success"><i class="fas fa-check-circle"></i> <span id="reason-count">0</span> reasons found</small>
            </div>

             <!-- Hidden field to store selected reasons as tags -->
            <input type="hidden" id="selectedReasons" name="selectedReasons">
            <div id="selectedReasonsDisplay" class="mt-2"></div>
          </div> 
        <!-- Copy To (Recipients) -->
        <div class="mb-3">
            <label for="copyToPractitioner" class="form-label">Copy Results To</label>
            <input 
                type="search" 
                class="form-control" 
                id="copyToPractitioner" 
                name="copyToPractitioner" 
                placeholder="start typing practitioner name..." 
                autocomplete="off"
                hx-get="/fhir/CopyToPractitioners"
                hx-trigger="input changed delay:500ms, keyup[!event.shiftKey && event.key=='Tab'] from:#copyToPractitioner"
                hx-target="#copyToPractitionerList"
                hx-include="closest form"
                hx-swap="innerHTML"
                hx-indicator="#copyToPractitioner-indicator"
                list="copyToPractitionerList"
            >
            <datalist id="copyToPractitionerList"></datalist>
            <div id="copyToPractitioner-indicator" class="htmx-indicator">
                <small class="text-muted">Searching...</small>
            </div>

             <!-- Hidden field to store selected practitioners as array -->
            <input type="hidden" id="copyTo" name="copyTo">
            <div id="copyToPractitionersDisplay" class="mt-2"></div>
        </div>
        <!-- Clinical context --> 
        </div>
          <div class="mb-3 mt-3">
            <label for="clinicalContext" class="form-label">Clinical Context for Request</label>
            <textarea class="form-control" id="clinicalContext" name="clinicalContext" rows="3"></textarea>
          </div>
          
          <!-- Add narrative toggle -->
          <div class="mb-3 mt-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="addNarrative" name="addNarrative" value="true">
              <label class="form-check-label" for="addNarrative">
                Add narrative text to all resources in the bundle
              </label>
            </div>            
          </div>
        </div>  
        <!-- Add narative slider--> 

        <!-- Submit Request bundle-->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" onclick="setTimeout(closeDialog, 100)">Submit Request</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
window.selectedTests = Array.isArray(window.selectedTests) ? window.selectedTests : [];

function renderSelectedTests() {
    const display = document.getElementById('selectedTestsDisplay');
    const hidden = document.getElementById('selectedTests');
    
    if (window.selectedTests.length === 0) {
        display.innerHTML = '<div class="text-muted small"><i class="fas fa-info-circle"></i> No tests selected yet</div>';
    } else {
        display.innerHTML = `
            <div class="mb-2">
                <small class="text-muted"><strong>Selected Tests (${window.selectedTests.length}):</strong></small>
            </div>
            ${window.selectedTests.map((test, idx) =>
                `<span class="badge bg-primary me-1 mb-1 d-inline-flex align-items-center" style="font-size: 0.9em;">
                    <span class="me-1">${idx + 1}.</span>
                    ${typeof test === 'string' ? test : test.display}
                    <button type="button" class="btn-close btn-close-white btn-sm ms-2" aria-label="Remove ${typeof test === 'string' ? test : test.display}" onclick="removeTest(${idx})" style="font-size:0.6em;" title="Remove test"></button>
                </span>`
            ).join('')}
        `;
    }
    
    hidden.value = JSON.stringify(window.selectedTests);
}

function addTestSelection() {
    const input = document.getElementById('testName');
    const value = input.value.trim();
    if (value && Array.isArray(window.selectedTests)) {
        // Check if we already have this test (by display name)
        const existingTest = window.selectedTests.find(test => 
            (typeof test === 'string' ? test : test.display) === value
        );
        
        if (!existingTest) {
            // Try to find the corresponding option in the dropdown to get the code
            const dropdown = document.getElementById('testNameDropdown');
            let testCode = '';
            let matchedDisplay = value;
            
            if (dropdown) {
                const options = dropdown.querySelectorAll('.test-option');
                
                // First try exact match with display text
                for (let option of options) {
                    const display = option.getAttribute('data-display');
                    if (display && display.toLowerCase() === value.toLowerCase()) {
                        testCode = option.getAttribute('data-code') || '';
                        matchedDisplay = display;
                        break;
                    }
                }
                
                // If no exact match, try partial match (user typed partial text)
                if (!testCode) {
                    for (let option of options) {
                        const display = option.getAttribute('data-display');
                        if (display && display.toLowerCase().includes(value.toLowerCase()) && value.length >= 3) {
                            testCode = option.getAttribute('data-code') || '';
                            matchedDisplay = display;
                            break;
                        }
                    }
                }
            }
            
            // Store as object with code, display, and display_sequence
            // The sequence is 1-indexed based on the order of addition
            window.selectedTests.push({
                code: testCode,
                display: matchedDisplay,
                display_sequence: window.selectedTests.length + 1
            });
            renderSelectedTests();
            input.value = '';
            
            // Hide dropdown
            hideTestDropdown();
            
            // Show brief success feedback
            showTestAddedFeedback(matchedDisplay);
        } else {
            // Show feedback that test is already added
            showTestAlreadyAddedFeedback(value);
            hideTestDropdown();
        }
    }
}

function showTestAddedFeedback(testName) {
    const input = document.getElementById('testName');
    const originalPlaceholder = input.placeholder;
    input.placeholder = `✓ "${testName}" added!`;
    input.style.backgroundColor = '#d1edff';
    
    setTimeout(() => {
        input.placeholder = originalPlaceholder;
        input.style.backgroundColor = '';
    }, 1500);
}

function showTestAlreadyAddedFeedback(testName) {
    const input = document.getElementById('testName');
    const originalPlaceholder = input.placeholder;
    input.placeholder = `⚠ "${testName}" already added`;
    input.style.backgroundColor = '#fff3cd';
    
    setTimeout(() => {
        input.placeholder = originalPlaceholder;
        input.style.backgroundColor = '';
    }, 1500);
}

function removeTest(idx) {
    if (Array.isArray(window.selectedTests)) {
        window.selectedTests.splice(idx, 1);
        // Recalculate display_sequence for remaining tests to maintain consecutive numbering
        window.selectedTests.forEach((test, index) => {
            if (typeof test === 'object') {
                test.display_sequence = index + 1;
            }
        });
        renderSelectedTests();
    }
}

// Add test on Enter, Tab, or when a dropdown option is picked
document.getElementById('testName').addEventListener('change', addTestSelection);
document.getElementById('testName').addEventListener('keydown', function(e) {
    const dropdown = document.getElementById('testNameDropdown');
    const options = dropdown.querySelectorAll('.test-option');
    
    if (e.key === 'Enter') {
        e.preventDefault();
        // If there are visible options and no specific one is highlighted, select the first one
        if (options.length > 0) {
            const highlighted = dropdown.querySelector('.test-option.highlighted');
            if (highlighted) {
                highlighted.click();
            } else {
                // Select first option
                options[0].click();
            }
        } else {
            setTimeout(addTestSelection, 10);
        }
    } else if (e.key === 'Tab') {
        setTimeout(addTestSelection, 10);
        hideTestDropdown();
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateDropdown('down');
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateDropdown('up');
    }
});

// Function to navigate dropdown with arrow keys
function navigateDropdown(direction) {
    const dropdown = document.getElementById('testNameDropdown');
    const options = dropdown.querySelectorAll('.test-option');
    
    if (options.length === 0) return;
    
    let currentIndex = -1;
    options.forEach((option, index) => {
        if (option.classList.contains('highlighted')) {
            currentIndex = index;
        }
        option.classList.remove('highlighted');
    });
    
    if (direction === 'down') {
        currentIndex = (currentIndex + 1) % options.length;
    } else {
        currentIndex = currentIndex <= 0 ? options.length - 1 : currentIndex - 1;
    }
    
    options[currentIndex].classList.add('highlighted');
    options[currentIndex].scrollIntoView({ block: 'nearest' });
}

// Show dropdown and handle test selection
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.target && evt.detail.target.id === 'testNameDropdown') {
        const dropdown = document.getElementById('testNameDropdown');
        const resultsDiv = document.getElementById('testName-results');
        const countSpan = document.getElementById('testName-count');
        const testNameInput = document.getElementById('testName');
        
        if (dropdown && resultsDiv && countSpan) {
            const testOptions = dropdown.querySelectorAll('.test-option');
            const optionCount = testOptions.length;
            
            if (optionCount > 0) {
                // Show dropdown with results
                dropdown.style.display = 'block';
                dropdown.classList.add('show');
                
                // Show count feedback
                countSpan.textContent = optionCount;
                resultsDiv.style.display = 'block';
                
                // Add success border styling
                testNameInput.style.borderColor = '#198754';
                testNameInput.style.boxShadow = '0 0 0 0.2rem rgba(25, 135, 84, 0.25)';
                
                // Add click handlers to test options
                testOptions.forEach(option => {
                    option.addEventListener('click', function(e) {
                        e.preventDefault();
                        const display = this.getAttribute('data-display');
                        const code = this.getAttribute('data-code');
                        
                        // Set the input value and trigger test addition
                        testNameInput.value = display;
                        addTestSelection();
                        
                        // Hide dropdown
                        hideTestDropdown();
                    });
                });
                
                // Hide results count after 3 seconds
                setTimeout(() => {
                    resultsDiv.style.display = 'none';
                }, 3000);
                
            } else {
                // No results found
                if (dropdown.innerHTML.trim()) {
                    dropdown.style.display = 'block';
                    dropdown.classList.add('show');
                } else {
                    hideTestDropdown();
                }
                resultsDiv.style.display = 'none';
                testNameInput.style.borderColor = '';
                testNameInput.style.boxShadow = '';
            }
        }
    }
});

// Function to hide test dropdown
function hideTestDropdown() {
    const dropdown = document.getElementById('testNameDropdown');
    const testNameInput = document.getElementById('testName');
    
    if (dropdown) {
        dropdown.style.display = 'none';
        dropdown.classList.remove('show');
    }
    
    // Reset input styling
    if (testNameInput) {
        testNameInput.style.borderColor = '';
        testNameInput.style.boxShadow = '';
    }
}

// Hide dropdown when clicking outside
document.addEventListener('click', function(e) {
    const testNameInput = document.getElementById('testName');
    const dropdown = document.getElementById('testNameDropdown');
    
    if (testNameInput && dropdown && !testNameInput.contains(e.target) && !dropdown.contains(e.target)) {
        hideTestDropdown();
    }
});

// Add CSS for highlighted dropdown items
const style = document.createElement('style');
style.textContent = `
    .test-option.highlighted,
    .reason-option.highlighted {
        background-color: #e9ecef !important;
        color: #495057 !important;
    }
    .test-option:hover,
    .reason-option:hover {
        background-color: #f8f9fa !important;
    }
    #testNameDropdown,
    #reasonDropdown {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    /* Hide browser's default search clear button */
    #reason::-webkit-search-cancel-button,
    #testName::-webkit-search-cancel-button {
        -webkit-appearance: none;
        appearance: none;
    }
    #reason::-ms-clear,
    #testName::-ms-clear {
        display: none;
    }
`;
document.head.appendChild(style);

// Hide dropdown when pressing Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideTestDropdown();
        hideReasonDropdown();
    }
});

// Reason functionality - similar to test functionality
window.selectedReasons = Array.isArray(window.selectedReasons) ? window.selectedReasons : [];

function renderSelectedReasons() {
    const display = document.getElementById('selectedReasonsDisplay');
    const hidden = document.getElementById('selectedReasons');
    
    if (window.selectedReasons.length === 0) {
        display.innerHTML = '<div class="text-muted small"><i class="fas fa-info-circle"></i> No reasons selected yet</div>';
    } else {
        display.innerHTML = `
            <div class="mb-2">
                <small class="text-muted"><strong>Selected Reasons (${window.selectedReasons.length}):</strong></small>
            </div>
            ${window.selectedReasons.map((reason, idx) =>
                `<span class="badge bg-secondary me-1 mb-1 d-inline-flex align-items-center" style="font-size: 0.9em;">
                    <span class="me-1">${idx + 1}.</span>
                    ${typeof reason === 'string' ? reason : reason.display}
                    ${reason.code ? '' : '<i class="fas fa-edit ms-1" title="Custom text"></i>'}
                    <button type="button" class="btn-close btn-close-white btn-sm ms-2" aria-label="Remove ${typeof reason === 'string' ? reason : reason.display}" onclick="removeReason(${idx})" style="font-size:0.6em;" title="Remove reason"></button>
                </span>`
            ).join('')}
        `;
    }
    
    hidden.value = JSON.stringify(window.selectedReasons);
}

function addReasonSelection() {
    const input = document.getElementById('reason');
    const value = input.value.trim();
    if (value && Array.isArray(window.selectedReasons)) {
        // Check if we already have this reason (by display name)
        const existingReason = window.selectedReasons.find(reason => 
            (typeof reason === 'string' ? reason : reason.display) === value
        );
        
        if (!existingReason) {
            // Try to find the corresponding option in the dropdown to get the code
            const dropdown = document.getElementById('reasonDropdown');
            let reasonCode = null;
            
            if (dropdown) {
                const options = dropdown.querySelectorAll('.reason-option');
                for (let option of options) {
                    if (option.getAttribute('data-display') === value) {
                        reasonCode = option.getAttribute('data-code') || null;
                        break;
                    }
                }
            }
            
            // Store as object with code, display, and display_sequence
            // For custom text, code will be null
            window.selectedReasons.push({
                code: reasonCode,
                display: value,
                display_sequence: window.selectedReasons.length + 1
            });
            renderSelectedReasons();
            
            // Clear input and hide dropdown
            input.value = '';
            hideReasonDropdown();
            
            // Force clear dropdown content to prevent it from showing again
            const reasonDropdownEl = document.getElementById('reasonDropdown');
            if (reasonDropdownEl) {
                reasonDropdownEl.innerHTML = '';
                reasonDropdownEl.style.display = 'none';
                reasonDropdownEl.classList.remove('show');
            }
            
            // Clear any visible results
            const resultsDiv = document.getElementById('reason-results');
            if (resultsDiv) {
                resultsDiv.style.display = 'none';
            }
            
            // Show brief success feedback
            showReasonAddedFeedback(value);
        } else {
            // Show feedback that reason is already added
            showReasonAlreadyAddedFeedback(value);
            hideReasonDropdown();
        }
    }
}

function showReasonAddedFeedback(reasonText) {
    const input = document.getElementById('reason');
    const originalPlaceholder = input.placeholder;
    input.placeholder = `✓ "${reasonText}" added!`;
    input.style.backgroundColor = '#d1edff';
    
    setTimeout(() => {
        input.placeholder = originalPlaceholder;
        input.style.backgroundColor = '';
    }, 1500);
}

function showReasonAlreadyAddedFeedback(reasonText) {
    const input = document.getElementById('reason');
    const originalPlaceholder = input.placeholder;
    input.placeholder = `⚠ "${reasonText}" already added`;
    input.style.backgroundColor = '#fff3cd';
    
    setTimeout(() => {
        input.placeholder = originalPlaceholder;
        input.style.backgroundColor = '';
    }, 1500);
}

function removeReason(idx) {
    if (Array.isArray(window.selectedReasons)) {
        window.selectedReasons.splice(idx, 1);
        // Recalculate display_sequence for remaining reasons to maintain consecutive numbering
        window.selectedReasons.forEach((reason, index) => {
            if (typeof reason === 'object') {
                reason.display_sequence = index + 1;
            }
        });
        renderSelectedReasons();
    }
}

// Add reason on Enter, Tab, or when a dropdown option is picked
document.getElementById('reason').addEventListener('change', addReasonSelection);
document.getElementById('reason').addEventListener('keydown', function(e) {
    const dropdown = document.getElementById('reasonDropdown');
    const options = dropdown.querySelectorAll('.reason-option');
    
    if (e.key === 'Enter') {
        e.preventDefault();
        // If there are visible options and no specific one is highlighted, select the first one
        if (options.length > 0) {
            const highlighted = dropdown.querySelector('.reason-option.highlighted');
            if (highlighted) {
                highlighted.click();
            } else {
                // Allow custom text entry when no specific option is highlighted
                hideReasonDropdown(); // Hide immediately
                setTimeout(addReasonSelection, 10);
            }
        } else {
            // No dropdown options, allow custom text
            hideReasonDropdown(); // Hide immediately for custom text
            setTimeout(addReasonSelection, 10);
        }
    } else if (e.key === 'Tab') {
        setTimeout(addReasonSelection, 10);
        hideReasonDropdown();
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        navigateReasonDropdown('down');
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        navigateReasonDropdown('up');
    }
});

// Function to navigate reason dropdown with arrow keys
function navigateReasonDropdown(direction) {
    const dropdown = document.getElementById('reasonDropdown');
    const options = dropdown.querySelectorAll('.reason-option');
    
    if (options.length === 0) return;
    
    let currentIndex = -1;
    options.forEach((option, index) => {
        if (option.classList.contains('highlighted')) {
            currentIndex = index;
        }
        option.classList.remove('highlighted');
    });
    
    if (direction === 'down') {
        currentIndex = (currentIndex + 1) % options.length;
    } else {
        currentIndex = currentIndex <= 0 ? options.length - 1 : currentIndex - 1;
    }
    
    options[currentIndex].classList.add('highlighted');
    options[currentIndex].scrollIntoView({ block: 'nearest' });
}

// Show reason dropdown and handle reason selection
document.body.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.target && evt.detail.target.id === 'reasonDropdown') {
        const dropdown = document.getElementById('reasonDropdown');
        const resultsDiv = document.getElementById('reason-results');
        const countSpan = document.getElementById('reason-count');
        const reasonInput = document.getElementById('reason');
        
        if (dropdown && resultsDiv && countSpan) {
            const reasonOptions = dropdown.querySelectorAll('.reason-option');
            const optionCount = reasonOptions.length;
            
            if (optionCount > 0) {
                // Show dropdown with results
                dropdown.style.display = 'block';
                dropdown.classList.add('show');
                
                // Show count feedback
                countSpan.textContent = optionCount;
                resultsDiv.style.display = 'block';
                
                // Add success border styling
                reasonInput.style.borderColor = '#198754';
                reasonInput.style.boxShadow = '0 0 0 0.2rem rgba(25, 135, 84, 0.25)';
                
                // Add click handlers to reason options
                reasonOptions.forEach(option => {
                    // Remove any existing click handlers to avoid duplicates
                    option.replaceWith(option.cloneNode(true));
                });
                
                // Re-query after cloning to get fresh elements
                const freshReasonOptions = dropdown.querySelectorAll('.reason-option');
                freshReasonOptions.forEach(option => {
                    option.addEventListener('click', function(e) {
                        e.preventDefault();
                        const display = this.getAttribute('data-display');
                        const code = this.getAttribute('data-code');
                        
                        // Set the input value and trigger reason addition
                        reasonInput.value = display;
                        
                        // Hide dropdown immediately
                        hideReasonDropdown();
                        
                        // Add the selection after a small delay to ensure dropdown is hidden
                        setTimeout(() => {
                            addReasonSelection();
                        }, 50);
                    });
                });
                
                // Hide results count after 3 seconds
                setTimeout(() => {
                    resultsDiv.style.display = 'none';
                }, 3000);
                
            } else {
                // No results found - still allow custom text entry
                if (dropdown.innerHTML.trim()) {
                    dropdown.style.display = 'block';
                    dropdown.classList.add('show');
                } else {
                    hideReasonDropdown();
                }
                resultsDiv.style.display = 'none';
                reasonInput.style.borderColor = '';
                reasonInput.style.boxShadow = '';
            }
        }
    }
});

// Function to hide reason dropdown
function hideReasonDropdown() {
    const dropdown = document.getElementById('reasonDropdown');
    const reasonInput = document.getElementById('reason');
    
    if (dropdown) {
        dropdown.style.display = 'none';
        dropdown.classList.remove('show');
    }
    
    // Reset input styling
    if (reasonInput) {
        reasonInput.style.borderColor = '';
        reasonInput.style.boxShadow = '';
    }
}

// Hide reason dropdown when clicking outside
document.addEventListener('click', function(e) {
    const reasonInput = document.getElementById('reason');
    const dropdown = document.getElementById('reasonDropdown');
    
    if (reasonInput && dropdown && !reasonInput.contains(e.target) && !dropdown.contains(e.target)) {
        hideReasonDropdown();
    }
});

// Additional event listener to ensure dropdown hides on any reason option click
document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('reason-option')) {
        // Force hide the dropdown when any reason option is clicked
        setTimeout(() => {
            hideReasonDropdown();
        }, 100);
    }
});

// Clear search functions
function clearTestNameSearch() {
    const input = document.getElementById('testName');
    const clearBtn = document.getElementById('clearTestName');
    
    input.value = '';
    clearBtn.style.display = 'none';
    hideTestDropdown();
    
    // Clear any results display
    const resultsDiv = document.getElementById('testName-results');
    if (resultsDiv) {
        resultsDiv.style.display = 'none';
    }
    
    // Reset input styling
    input.style.borderColor = '';
    input.style.boxShadow = '';
    
    // Focus back on input
    input.focus();
}

function clearReasonSearch() {
    const input = document.getElementById('reason');
    const clearBtn = document.getElementById('clearReason');
    
    input.value = '';
    clearBtn.style.display = 'none';
    hideReasonDropdown();
    
    // Clear any results display
    const resultsDiv = document.getElementById('reason-results');
    if (resultsDiv) {
        resultsDiv.style.display = 'none';
    }
    
    // Reset input styling
    input.style.borderColor = '';
    input.style.boxShadow = '';
    
    // Focus back on input
    input.focus();
}

// Show/hide clear buttons based on input content
document.getElementById('testName').addEventListener('input', function() {
    const clearBtn = document.getElementById('clearTestName');
    if (this.value.trim()) {
        clearBtn.style.display = 'block';
    } else {
        clearBtn.style.display = 'none';
    }
});

document.getElementById('reason').addEventListener('input', function() {
    const clearBtn = document.getElementById('clearReason');
    if (this.value.trim()) {
        clearBtn.style.display = 'block';
    } else {
        clearBtn.style.display = 'none';
    }
});

// Clear testName and selectedTests when requestCategory changes
document.querySelectorAll('input[name="requestCategory"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.getElementById('testName').value = '';
        window.selectedTests = [];
        renderSelectedTests();
    });
});

// Blur close button on modal close to avoid aria-hidden accessibility warning
document.querySelectorAll('.btn-close[data-bs-dismiss="modal"]').forEach(btn => {
    btn.addEventListener('click', function() {
        this.blur();
    });
});

// Reason for Request
window.selectedReasons = Array.isArray(window.selectedReasons) ? window.selectedReasons : [];

function renderSelectedReasons() {
    const display = document.getElementById('selectedReasonsDisplay');
    const hidden = document.getElementById('selectedReasons');
    display.innerHTML = window.selectedReasons.map((reason, idx) =>
        `<span class="badge bg-secondary text-dark me-1 mb-1">
            ${typeof reason === 'string' ? reason : reason.display}
            <button type="button" class="btn-close btn-close-white btn-sm ms-1" aria-label="Remove" onclick="removeReason(${idx})" style="font-size:0.7em; vertical-align:middle;"></button>
        </span>`
    ).join('');
    hidden.value = JSON.stringify(window.selectedReasons);
}



function removeReason(idx) {
    if (Array.isArray(window.selectedReasons)) {
        window.selectedReasons.splice(idx, 1);
        renderSelectedReasons();
    }
}

// Copy To Practitioners
window.selectedCopyToPractitioners = Array.isArray(window.selectedCopyToPractitioners) ? window.selectedCopyToPractitioners : [];

function renderSelectedCopyToPractitioners() {
    const display = document.getElementById('copyToPractitionersDisplay');
    const hidden = document.getElementById('copyTo');
    display.innerHTML = window.selectedCopyToPractitioners.map((practitioner, idx) =>
        `<span class="badge bg-warning text-dark me-1 mb-1">
            ${typeof practitioner === 'string' ? practitioner : practitioner.display}
            <button type="button" class="btn-close btn-close-white btn-sm ms-1" aria-label="Remove" onclick="removeCopyToPractitioner(${idx})" style="font-size:0.7em; vertical-align:middle;"></button>
        </span>`
    ).join('');
    // Store only the IDs in the hidden field for form submission
    const practitionerIds = window.selectedCopyToPractitioners.map(practitioner => 
        typeof practitioner === 'string' ? practitioner : practitioner.id
    );
    hidden.value = JSON.stringify(practitionerIds);
}

function addCopyToPractitionerSelection() {
    const input = document.getElementById('copyToPractitioner');
    const value = input.value.trim();
    if (value && Array.isArray(window.selectedCopyToPractitioners)) {
        // Check if we already have this practitioner (by display name)
        const existingPractitioner = window.selectedCopyToPractitioners.find(practitioner => 
            (typeof practitioner === 'string' ? practitioner : practitioner.display) === value
        );
        
        if (!existingPractitioner) {
            // Try to find the corresponding option in the datalist to get the ID
            const datalist = document.getElementById('copyToPractitionerList');
            const options = datalist.querySelectorAll('option');
            let practitionerId = '';
            
            for (let option of options) {
                if (option.value === value) {
                    practitionerId = option.getAttribute('data-code') || '';
                    break;
                }
            }
            
            // Store as object with id and display
            window.selectedCopyToPractitioners.push({
                id: practitionerId,
                display: value
            });
            renderSelectedCopyToPractitioners();
            input.value = '';
        }
    }
}

function removeCopyToPractitioner(idx) {
    if (Array.isArray(window.selectedCopyToPractitioners)) {
        window.selectedCopyToPractitioners.splice(idx, 1);
        renderSelectedCopyToPractitioners();
    }
}

// Show and load provider organisations based on Request Category
function updateProviderDropdown() {
    const pathologyRadio = document.getElementById('pathologyRequest');
    const radiologyRadio = document.getElementById('radiologyRequest');
    const orgList = document.getElementById('organisationList');
    const specimenSection = document.getElementById('specimenSection');
    const specimenCheckboxSection = document.getElementById('specimenCheckboxSection');
    let snomedCode = null;

    if (pathologyRadio.checked) {
        snomedCode = '310074003';
        // Show specimen checkbox section for pathology
        if (specimenCheckboxSection) {
            specimenCheckboxSection.style.display = 'block';
        }
        // Update specimen section visibility based on checkbox
        updateSpecimenSectionVisibility();
    } else if (radiologyRadio.checked) {
        snomedCode = '708175003';
        // Hide specimen sections for radiology
        if (specimenCheckboxSection) {
            specimenCheckboxSection.style.display = 'none';
        }
        if (specimenSection) {
            specimenSection.style.display = 'none';
        }
    }

    if (snomedCode) {
        // Load organisations for the selected SNOMED code
        htmx.ajax('GET', `/fhir/Provider/${snomedCode}`, '#providerDropdownContainer');
    } else {
        orgList.innerHTML = '<option value="">Select an provider...</option>';
    }
}

function updateSpecimenSectionVisibility() {
    const specimenCollectedCheckbox = document.getElementById('specimenCollected');
    const specimenSection = document.getElementById('specimenSection');
    const pathologyRadio = document.getElementById('pathologyRequest');
    
    // Only show specimen section if pathology is selected AND checkbox is checked
    if (pathologyRadio && pathologyRadio.checked && specimenCollectedCheckbox && specimenCollectedCheckbox.checked) {
        if (specimenSection) {
            specimenSection.style.display = 'block';
        }
    } else {
        if (specimenSection) {
            specimenSection.style.display = 'none';
        }
    }
}

// Attach event listeners to Request Category radios
document.getElementById('pathologyRequest').addEventListener('change', updateProviderDropdown);
document.getElementById('radiologyRequest').addEventListener('change', updateProviderDropdown);

// Attach event listener to specimen collection checkbox
document.getElementById('specimenCollected').addEventListener('change', updateSpecimenSectionVisibility);

// Attach event listeners to requestingContext radios
document.querySelectorAll('input[name="requestingContext"]').forEach(radio => {
    radio.addEventListener('change', updateSpecialistDropdown);
});

// Add reason on Enter, Tab, or when a datalist option is picked
document.getElementById('reason').addEventListener('change', addReasonSelection);
// Add copyTo practitioner on Enter, Tab, or when a datalist option is picked
document.getElementById('copyToPractitioner').addEventListener('change', addCopyToPractitionerSelection);
document.getElementById('copyToPractitioner').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === 'Tab') {
        setTimeout(addCopyToPractitionerSelection, 10);
    }
});

// Handle Request Status toggle to show/hide status reason field
function updateStatusReasonVisibility() {
    const onHoldRadio = document.getElementById('requestStatusOnHold');
    const statusReasonContainer = document.getElementById('statusReasonContainer');
    const statusReasonField = document.getElementById('statusReason');
    
    if (onHoldRadio.checked) {
        statusReasonContainer.style.display = 'block';
        statusReasonField.required = true;
    } else {
        statusReasonContainer.style.display = 'none';
        statusReasonField.required = false;
        statusReasonField.value = ''; // Clear the field when hiding
    }
}

// Attach event listeners to Request Status radios
document.getElementById('requestStatusActive').addEventListener('change', updateStatusReasonVisibility);
document.getElementById('requestStatusOnHold').addEventListener('change', updateStatusReasonVisibility);

// Reset selectedTests and selectedReasons when the modal is opened
document.getElementById('createDiagnosticRequestModal').addEventListener('shown.bs.modal', function () {
  // initialise Provider list
    updateProviderDropdown(); 

  // Clear selected tests
    window.selectedTests = [];
    renderSelectedTests();

    // Clear selected reasons
    window.selectedReasons = [];
    renderSelectedReasons();

    // Clear selected copyTo practitioners
    window.selectedCopyToPractitioners = [];
    renderSelectedCopyToPractitioners();

    // Clear input fields
    document.getElementById('testName').value = '';
    document.getElementById('reason').value = '';
    document.getElementById('copyToPractitioner').value = '';
    
    // Reset request status to active and hide status reason field
    document.getElementById('requestStatusActive').checked = true;
    document.getElementById('requestStatusOnHold').checked = false;
    updateStatusReasonVisibility();
    
    // Clear specimen fields
    document.getElementById('specimenType').value = '';
    document.getElementById('specimenTypeCode').value = '';
    document.getElementById('specimenTypeDisplay').value = '';
    document.getElementById('collectionMethod').value = '';
    document.getElementById('collectionMethodCode').value = '';
    document.getElementById('collectionMethodDisplay').value = '';
    document.getElementById('bodySite').value = '';
    document.getElementById('bodySiteCode').value = '';
    document.getElementById('bodySiteDisplay').value = '';
    
    // Set default collection date/time to current time
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const localDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    
    const collectionDateTimeInput = document.getElementById('collectionDateTime');
    if (collectionDateTimeInput) {
        collectionDateTimeInput.value = localDateTime;
    }
});

function closeDialog() {
    let modalEl = document.getElementById('createDiagnosticRequestModal');
    let modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
    modalInstance.hide();
    console.log('modal should be hidden now...')
}

// Function to capture SNOMED codes for specimen fields
function captureSpecimenCode(inputId, codeFieldId, displayFieldId) {
    const input = document.getElementById(inputId);
    const codeField = document.getElementById(codeFieldId);
    const displayField = document.getElementById(displayFieldId);
    const value = input.value.trim();
    
    if (value) {
        // Find the corresponding option in the datalist to get the code
        const datalistId = input.getAttribute('list');
        const datalist = document.getElementById(datalistId);
        const options = datalist.querySelectorAll('option');
        
        let foundCode = '';
        for (let option of options) {
            if (option.value === value) {
                foundCode = option.getAttribute('data-code') || '';
                break;
            }
        }
        
        // Store both code and display
        if (codeField) codeField.value = foundCode;
        if (displayField) displayField.value = value;
        
        console.log(`Captured ${inputId}: code="${foundCode}", display="${value}"`);
    } else {
        // Clear if empty
        if (codeField) codeField.value = '';
        if (displayField) displayField.value = '';
    }
}

// Add event listeners for specimen fields
document.addEventListener('DOMContentLoaded', function() {
    // Specimen Type
    const specimenTypeInput = document.getElementById('specimenType');
    if (specimenTypeInput) {
        specimenTypeInput.addEventListener('change', function() {
            captureSpecimenCode('specimenType', 'specimenTypeCode', 'specimenTypeDisplay');
        });
        specimenTypeInput.addEventListener('blur', function() {
            captureSpecimenCode('specimenType', 'specimenTypeCode', 'specimenTypeDisplay');
        });
    }
    
    // Collection Method
    const collectionMethodInput = document.getElementById('collectionMethod');
    if (collectionMethodInput) {
        collectionMethodInput.addEventListener('change', function() {
            captureSpecimenCode('collectionMethod', 'collectionMethodCode', 'collectionMethodDisplay');
        });
        collectionMethodInput.addEventListener('blur', function() {
            captureSpecimenCode('collectionMethod', 'collectionMethodCode', 'collectionMethodDisplay');
        });
    }
    
    // Body Site
    const bodySiteInput = document.getElementById('bodySite');
    if (bodySiteInput) {
        bodySiteInput.addEventListener('change', function() {
            captureSpecimenCode('bodySite', 'bodySiteCode', 'bodySiteDisplay');
        });
        bodySiteInput.addEventListener('blur', function() {
            captureSpecimenCode('bodySite', 'bodySiteCode', 'bodySiteDisplay');
        });
    }
});
</script>